<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Feedback Insights - Alumni Portal</title>
    <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
      .filter-section {
        background: #f8fafc;
        padding: 14px 18px;
        border-radius: 8px;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .filter-section label {
        font-size: 13px;
        font-weight: 600;
        color: #475569;
      }
      .filter-section select {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        font-size: 13px;
      }
      .filter-section button {
        padding: 6px 16px;
        border-radius: 6px;
        border: none;
        background: #0ea5e9;
        color: white;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
      }
      .filter-section button:hover {
        background: #0284c7;
      }
      .filter-section button.secondary {
        background: #64748b;
      }
      .filter-section button.secondary:hover {
        background: #475569;
    }
    .chart-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.06);
        margin-bottom: 24px;
      }
      .chart-card h3 {
        margin: 0 0 8px 0;
        color: #1e293b;
        font-size: 18px;
      }
      .chart-card h4 {
        margin: 0 0 16px 0;
        color: #64748b;
        font-size: 14px;
        font-weight: 500;
    }
    .chart-note {
        font-size: 12px;
        color: #64748b;
        margin-top: 8px;
      }
      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .stat-card {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        padding: 20px;
        border-radius: 12px;
        color: white;
      }
      .stat-card h4 {
        margin: 0 0 8px 0;
        font-size: 13px;
        opacity: 0.9;
        font-weight: 500;
      }
      .stat-card .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin: 0;
      }
      .drilldown-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .drilldown-content {
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 1000px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      .close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        font-size: 28px;
        font-weight: bold;
        color: #64748b;
        cursor: pointer;
        background: none;
        border: none;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
      }
      .close-btn:hover {
        background: #f1f5f9;
        color: #1e293b;
      }
      .insights-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
      }
      .insight-chart {
        background: #ffffff;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }
      .insight-chart h4 {
        margin: 0 0 12px 0;
      font-size: 14px;
      color: #475569;
        font-weight: 600;
    }
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Alumni Portal</h2>
    <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
    <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
    <a href="events.html"><i class="fas fa-calendar"></i> Events</a>
    <a href="mentorship-report.html"><i class="fas fa-handshake"></i> Mentorship Report</a>
    <a href="event-report.html"><i class="fas fa-chart-bar"></i> Event Report</a>
    <a href="donations.html"><i class="fas fa-heart"></i> Donations</a>
    <a href="feedback-report.html" class="active"><i class="fas fa-chart-line"></i> Feedback Insight</a>
    <a href="feedback.html"><i class="fas fa-comment"></i> Submit Feedback</a>
    <a href="logout.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <div style="max-width: 1100px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div>
          <h2 class="section-title" style="margin: 0;">Feedback Insights</h2>
          <p style="margin: 8px 0 0 0;">Comprehensive feedback analysis merged with engagement and profile data</p>
        </div>
        <a href="dashboard.html" class="details-btn" style="margin: 0;">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
      </div>

    <!-- Summary Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 32px;">
      <div style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 8px 0; color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Total Feedback</h4>
        <p style="margin: 0; color: white; font-size: 32px; font-weight: 700;" id="totalFeedback">-</p>
      </div>
      <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 8px 0; color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">5-Star Ratings</h4>
        <p style="margin: 0; color: white; font-size: 32px; font-weight: 700;" id="fiveStarCount">-</p>
      </div>
      <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 8px 0; color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Active Contributors</h4>
        <p style="margin: 0; color: white; font-size: 32px; font-weight: 700;" id="activeContributors">-</p>
        </div>
      <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 8px 0; color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Most Active Department</h4>
        <p style="margin: 0; color: white; font-size: 26px; font-weight: 700;" id="topDept">-</p>
        </div>
        </div>

    <!-- Deep Insights Button -->
    <div class="filter-section" style="justify-content: flex-end;">
      <button onclick="showDeepInsightsModal()" style="background: #8b5cf6;">
        <i class="fas fa-chart-pie"></i> Deep Insights
      </button>
        </div>

    <!-- Chart 1: Feedback by Graduation Year -->
    <div class="chart-card">
      <h3>Feedback by Graduation Year</h3>
        <h4>Which cohorts are most engaged in providing feedback</h4>
        
        <div class="filter-section">
          <label for="gradYearFilterYear">Year:</label>
          <select id="gradYearFilterYear">
            <option value="all">All Years</option>
          </select>
          <label for="gradYearFilterMonth">Month:</label>
          <select id="gradYearFilterMonth">
            <option value="all">All Months</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
          <button onclick="applyGradYearFilter()">Apply</button>
          <button class="secondary" onclick="resetGradYearFilter()">Reset</button>
        </div>

      <canvas id="feedbackByGradYearChart" style="cursor: pointer;"></canvas>
      <p class="chart-note">Click on any cohort to see detailed feedback from that graduation year</p>
    </div>

    <!-- Chart 2: Feedback by Department -->
    <div class="chart-card">
      <h3>Feedback by Department</h3>
        <h4>Department-level feedback participation</h4>
        
        <div class="filter-section">
          <label for="deptFilterYear">Year:</label>
          <select id="deptFilterYear">
            <option value="all">All Years</option>
          </select>
          <label for="deptFilterMonth">Month:</label>
          <select id="deptFilterMonth">
            <option value="all">All Months</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
          <button onclick="applyDeptFilter()">Apply</button>
          <button class="secondary" onclick="resetDeptFilter()">Reset</button>
        </div>
        
      <canvas id="feedbackByDeptChart" style="cursor: pointer;"></canvas>
      <p class="chart-note">Click on any department to see their feedback details</p>
    </div>

    <!-- Chart 3: Feedback Rating Distribution -->
    <div class="chart-card">
      <h3>Feedback Rating Distribution</h3>
        <h4>Overall satisfaction levels</h4>
        
        <div class="filter-section">
          <label for="ratingFilterYear">Year:</label>
          <select id="ratingFilterYear">
            <option value="all">All Years</option>
          </select>
          <label for="ratingFilterMonth">Month:</label>
          <select id="ratingFilterMonth">
            <option value="all">All Months</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
          <button onclick="applyRatingFilter()">Apply</button>
          <button class="secondary" onclick="resetRatingFilter()">Reset</button>
        </div>
        
      <div style="max-width: 500px; margin: 0 auto;">
        <canvas id="ratingDistributionChart" style="cursor: pointer;"></canvas>
      </div>
      <p class="chart-note">Click on any rating to see detailed feedback from alumni</p>
    </div>

    <!-- Chart 5: Feedback by User Role -->
    <div class="chart-card">
      <h3>Feedback by User Role</h3>
        <h4>Feedback participation by alumni role</h4>
        
        <div class="filter-section">
          <label for="roleFilterYear">Year:</label>
          <select id="roleFilterYear">
            <option value="all">All Years</option>
          </select>
          <label for="roleFilterMonth">Month:</label>
          <select id="roleFilterMonth">
            <option value="all">All Months</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
          <button onclick="applyRoleFilter()">Apply</button>
          <button class="secondary" onclick="resetRoleFilter()">Reset</button>
        </div>

      <canvas id="feedbackByRoleChart" style="cursor: pointer;"></canvas>
      <p class="chart-note">Mentors, mentees, and general alumni feedback patterns</p>
    </div>

    <!-- How to Use This Analysis -->
    <div class="report-card" style="margin-top: 32px;">
      <h3 style="color: #1d3557; margin-bottom: 16px;">üìä How to Use This Analysis</h3>
      <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
        <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
          <li><strong>Click on any chart</strong> to see what fellow alumni from your graduation year, department, or role are saying</li>
          <li><strong>Use filters</strong> to explore feedback from specific time periods and see how alumni experiences have evolved</li>
          <li><strong>Click "Deep Insights"</strong> to discover which alumni groups are most engaged and what topics matter most to the community</li>
          <li><strong>Use the Connect button</strong> to reach out to alumni who share similar experiences or interests</li>
        </ul>
      </div>
      </div>

    <!-- Recommendations -->
    <div class="report-card" style="margin-top: 24px;">
      <h3 style="color: #1d3557; margin-bottom: 16px;">üí° How You Can Help</h3>
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white;">
        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
          <li>Share your own feedback to help the community understand what's working and what needs improvement</li>
          <li>Read what your classmates and peers are saying to stay informed about community initiatives</li>
          <li>Connect with alumni who have similar experiences or concerns to build your network</li>
          <li>Support programs that receive positive feedback and advocate for improvements in areas with concerns</li>
          <li>Encourage fellow alumni to participate and share their voices to strengthen the community</li>
        </ul>
      </div>
    </div>
    </div> <!-- Close max-width wrapper -->
  </div>

  <!-- Deep Insights Modal -->
  <div class="drilldown-modal" id="deepInsightsModal">
    <div class="drilldown-content" style="max-width: 1200px;">
      <button class="close-btn" onclick="closeDeepInsightsModal()">&times;</button>
      <h3 style="color: #1d3557; margin-bottom: 20px;">Deep Feedback Insights</h3>
      
      <div class="insights-grid" style="grid-template-columns: repeat(2, 1fr);">
        <!-- Insight 1: Top Feedback Cohorts -->
        <div class="insight-chart">
          <h4>Top 5 Cohorts by Feedback Volume</h4>
          <canvas id="topCohortsChart" style="max-height: 250px;"></canvas>
        </div>
        
        <!-- Insight 2: Theme Frequency Heatmap -->
        <div class="insight-chart">
          <h4>Feedback Theme Frequency</h4>
          <canvas id="themeHeatmapChart" style="max-height: 250px;"></canvas>
        </div>
      </div>
      
      <!-- Analysis Text -->
      <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9; margin-top: 24px;">
        <h4 style="margin: 0 0 12px 0; font-size: 15px; color: #0c4a6e; font-weight: 600;">Key Insights</h4>
        <p id="deepInsightsText" style="margin: 0; font-size: 14px; color: #475569; line-height: 1.8;"></p>
      </div>
    </div>
  </div>

  <!-- Detail Modal for Drill-downs -->
  <div class="drilldown-modal" id="detailModal" style="z-index: 2000;">
    <div class="drilldown-content" style="max-width: 800px;">
      <button class="close-btn" onclick="closeDetailModal()">&times;</button>
      <h3 id="detailModalTitle" style="color: #1d3557; margin-bottom: 20px;"></h3>
      <div id="detailModalContent"></div>
  </div>
</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variables
    let allFeedback = [];
    let allAlumni = [];
    let allEvents = [];
    let allAlumniEvents = [];
    let allMentorships = [];
    let allDonations = [];
    let chartInstances = {};
    let deepInsightsCharts = {};
    // Individual filters for each chart
    let gradYearFilter = { year: 'all', month: 'all' };
    let deptFilter = { year: 'all', month: 'all' };
    let ratingFilter = { year: 'all', month: 'all' };
    let roleFilter = { year: 'all', month: 'all' };

    // Redirect if not logged in
    if (!localStorage.getItem("isLoggedIn")) {
      window.location.href = "index.html";
    }

    // Load CSV helper
    function loadCSV(path) {
      return new Promise((resolve, reject) => {
        Papa.parse(path, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: results => resolve(results.data),
          error: err => {
            console.warn(`Could not load ${path}:`, err);
            resolve([]);
          }
        });
      });
    }

    // Initialize the analysis
    async function initFeedbackAnalysis() {
      // Load all datasets
      [allFeedback, allAlumni, allEvents, allAlumniEvents, allMentorships, allDonations] = await Promise.all([
        loadCSV("./data/Feedback.csv"),
        loadCSV("./data/Alumni.csv"),
        loadCSV("./data/Event.csv"),
        loadCSV("./data/AlumniEvent.csv"),
        loadCSV("./data/Mentorship.csv"),
        loadCSV("./data/Donation.csv")
      ]);

      // Populate year filters for each chart
      const yearsSet = new Set();
      allFeedback.forEach(fb => {
        if (fb.FeedbackDate) {
          const date = new Date(fb.FeedbackDate);
          if (!isNaN(date.getTime())) {
            yearsSet.add(date.getFullYear());
          }
        }
      });
      const sortedYears = Array.from(yearsSet).sort((a, b) => b - a);
      
      // Populate year dropdowns for charts that need them
      ['gradYearFilterYear', 'deptFilterYear', 'ratingFilterYear', 'roleFilterYear'].forEach(selectId => {
        const yearSelect = document.getElementById(selectId);
        sortedYears.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
      });

      renderAnalysis();
    }

    // Main render function
    function renderAnalysis() {
      // Build alumni map
      const alumniMap = {};
      allAlumni.forEach(alumni => {
        if (alumni.AlumniID) {
          alumniMap[alumni.AlumniID] = alumni;
        }
      });

      // No global filter - show all feedback for summary statistics
      let allValidFeedback = allFeedback.filter(fb => {
        if (!fb.FeedbackDate) return false;
        const date = new Date(fb.FeedbackDate);
        return !isNaN(date.getTime());
      });

      // Calculate engagement metrics for each alumni
      const engagementMap = {};
      
      // Events attended
      allAlumniEvents.forEach(ae => {
        if (ae.AlumniID) {
          if (!engagementMap[ae.AlumniID]) {
            engagementMap[ae.AlumniID] = { events: 0, mentorships: 0, donations: 0 };
          }
          engagementMap[ae.AlumniID].events++;
        }
      });

      // Mentorships
      allMentorships.forEach(m => {
        if (m.MentorAlumniID) {
          if (!engagementMap[m.MentorAlumniID]) {
            engagementMap[m.MentorAlumniID] = { events: 0, mentorships: 0, donations: 0 };
          }
          engagementMap[m.MentorAlumniID].mentorships++;
        }
        if (m.MenteeAlumniID) {
          if (!engagementMap[m.MenteeAlumniID]) {
            engagementMap[m.MenteeAlumniID] = { events: 0, mentorships: 0, donations: 0 };
          }
          engagementMap[m.MenteeAlumniID].mentorships++;
        }
      });

      // Donations
      allDonations.forEach(d => {
        if (d.AlumniID) {
          if (!engagementMap[d.AlumniID]) {
            engagementMap[d.AlumniID] = { events: 0, mentorships: 0, donations: 0 };
          }
          engagementMap[d.AlumniID].donations++;
        }
      });

      // Update summary statistics (using all feedback)
      document.getElementById('totalFeedback').textContent = allValidFeedback.length;
      
      // Count 5-star ratings
      const fiveStarCount = allValidFeedback.filter(fb => fb.Rating && parseInt(fb.Rating) === 5).length;
      document.getElementById('fiveStarCount').textContent = fiveStarCount;

      // Count active contributors (unique alumni who submitted feedback)
      const uniqueAlumniWithFeedback = new Set(allValidFeedback.map(fb => fb.AlumniID)).size;
      document.getElementById('activeContributors').textContent = uniqueAlumniWithFeedback;

      // Most active department
      const deptCounts = {};
      allValidFeedback.forEach(fb => {
        const alumni = alumniMap[fb.AlumniID];
        if (alumni && alumni.Department) {
          deptCounts[alumni.Department] = (deptCounts[alumni.Department] || 0) + 1;
        }
      });
      const topDept = Object.keys(deptCounts).length > 0
        ? Object.keys(deptCounts).reduce((a, b) => deptCounts[a] > deptCounts[b] ? a : b)
        : 'N/A';
      document.getElementById('topDept').textContent = topDept;

      // Destroy existing charts
      Object.values(chartInstances).forEach(chart => {
        if (chart) chart.destroy();
      });
      chartInstances = {};

      // Chart 1: Feedback by Graduation Year (apply gradYearFilter)
      const gradYearFilteredFeedback = allValidFeedback.filter(fb => {
        const date = new Date(fb.FeedbackDate);
        const fbYear = date.getFullYear();
        const fbMonth = date.getMonth() + 1;
        if (gradYearFilter.year !== 'all' && fbYear !== parseInt(gradYearFilter.year)) {
          return false;
        }
        if (gradYearFilter.month !== 'all' && fbMonth !== parseInt(gradYearFilter.month)) {
          return false;
        }
        return true;
      });
      
      const gradYearCounts = {};
      gradYearFilteredFeedback.forEach(fb => {
        const alumni = alumniMap[fb.AlumniID];
        if (alumni && alumni.GraduationYear) {
          gradYearCounts[alumni.GraduationYear] = (gradYearCounts[alumni.GraduationYear] || 0) + 1;
        }
      });
      const gradYears = Object.keys(gradYearCounts).sort();
      
      chartInstances.gradYear = new Chart(document.getElementById('feedbackByGradYearChart'), {
        type: 'bar',
        data: {
          labels: gradYears,
          datasets: [{
            label: 'Feedback Count',
            data: gradYears.map(year => gradYearCounts[year]),
            backgroundColor: '#0ea5e9',
            borderColor: '#0284c7',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const year = gradYears[index];
              showGradYearDetail(year, gradYearFilteredFeedback, alumniMap);
            }
          }
        }
      });

      // Chart 2: Feedback by Department (apply deptFilter)
      const deptFilteredFeedback = allValidFeedback.filter(fb => {
        const date = new Date(fb.FeedbackDate);
        const fbYear = date.getFullYear();
        const fbMonth = date.getMonth() + 1;
        if (deptFilter.year !== 'all' && fbYear !== parseInt(deptFilter.year)) {
          return false;
        }
        if (deptFilter.month !== 'all' && fbMonth !== parseInt(deptFilter.month)) {
          return false;
        }
        return true;
      });
      
      const deptCounts2 = {};
      deptFilteredFeedback.forEach(fb => {
        const alumni = alumniMap[fb.AlumniID];
        if (alumni && alumni.Department) {
          deptCounts2[alumni.Department] = (deptCounts2[alumni.Department] || 0) + 1;
        }
      });
      const depts = Object.keys(deptCounts2).sort((a, b) => deptCounts2[b] - deptCounts2[a]).slice(0, 10);

      chartInstances.dept = new Chart(document.getElementById('feedbackByDeptChart'), {
        type: 'bar',
        data: {
          labels: depts,
          datasets: [{
            label: 'Feedback Count',
            data: depts.map(dept => deptCounts2[dept]),
            backgroundColor: '#10b981',
            borderColor: '#059669',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true, ticks: { stepSize: 1 } }
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const dept = depts[index];
              showDeptDetail(dept, deptFilteredFeedback, alumniMap);
            }
          }
        }
      });

      // Chart 3: Rating Distribution (apply ratingFilter)
      const ratingFilteredFeedback = allValidFeedback.filter(fb => {
        const date = new Date(fb.FeedbackDate);
        const fbYear = date.getFullYear();
        const fbMonth = date.getMonth() + 1;
        if (ratingFilter.year !== 'all' && fbYear !== parseInt(ratingFilter.year)) {
          return false;
        }
        if (ratingFilter.month !== 'all' && fbMonth !== parseInt(ratingFilter.month)) {
          return false;
        }
        return true;
      });
      
      const ratingCounts = { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 };
      ratingFilteredFeedback.forEach(fb => {
        if (fb.Rating && fb.Rating >= 1 && fb.Rating <= 5) {
          ratingCounts[fb.Rating]++;
        }
      });

      chartInstances.rating = new Chart(document.getElementById('ratingDistributionChart'), {
        type: 'doughnut',
        data: {
          labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
          datasets: [{
            data: Object.values(ratingCounts),
            backgroundColor: ['#ef4444', '#f59e0b', '#eab308', '#84cc16', '#10b981'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const rating = index + 1; // Convert index (0-4) to rating (1-5)
              showRatingDetail(rating, ratingFilteredFeedback, alumniMap);
            }
          }
        }
      });

      // Chart 4: Feedback by User Role (apply roleFilter)
      const roleFilteredFeedback = allValidFeedback.filter(fb => {
        const date = new Date(fb.FeedbackDate);
        const fbYear = date.getFullYear();
        const fbMonth = date.getMonth() + 1;
        if (roleFilter.year !== 'all' && fbYear !== parseInt(roleFilter.year)) {
          return false;
        }
        if (roleFilter.month !== 'all' && fbMonth !== parseInt(roleFilter.month)) {
          return false;
        }
        return true;
      });
      
      const roleCounts = { 'Mentor': 0, 'Mentee': 0, 'Donor': 0, 'Event Attendee': 0, 'General Alumni': 0 };
      
      roleFilteredFeedback.forEach(fb => {
        const eng = engagementMap[fb.AlumniID];
        if (!eng || (eng.events === 0 && eng.mentorships === 0 && eng.donations === 0)) {
          roleCounts['General Alumni']++;
        } else {
          if (eng.mentorships > 0) {
            // Check if mentor or mentee
            const isMentor = allMentorships.some(m => m.MentorAlumniID === fb.AlumniID);
            if (isMentor) {
              roleCounts['Mentor']++;
            } else {
              roleCounts['Mentee']++;
            }
          } else if (eng.donations > 0) {
            roleCounts['Donor']++;
          } else if (eng.events > 0) {
            roleCounts['Event Attendee']++;
          }
        }
      });

      chartInstances.role = new Chart(document.getElementById('feedbackByRoleChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(roleCounts),
          datasets: [{
            label: 'Feedback Count',
            data: Object.values(roleCounts),
            backgroundColor: ['#8b5cf6', '#6366f1', '#06b6d4', '#14b8a6', '#64748b'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const role = Object.keys(roleCounts)[index];
              showRoleDetail(role, roleFilteredFeedback, alumniMap, engagementMap);
            }
          }
        }
      });
    }

    // Drill-down functions
    function showGradYearDetail(year, feedback, alumniMap) {
      const yearFeedback = feedback.filter(fb => {
        const alumni = alumniMap[fb.AlumniID];
        return alumni && alumni.GraduationYear == year;
      });

      let content = `
        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 8px 0; color: #1d3557;">Class of ${year}</h4>
          <p style="margin: 0; color: #64748b; font-size: 14px;">${yearFeedback.length} feedback submissions</p>
        </div>
      `;

      yearFeedback.slice(0, 10).forEach(fb => {
        const alumni = alumniMap[fb.AlumniID];
        content += `
          <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                <h5 style="margin: 0 0 4px 0; color: #1e293b; font-size: 15px;">${alumni ? `${alumni.FirstName} ${alumni.LastName}` : 'Anonymous'}</h5>
                <p style="margin: 0; color: #64748b; font-size: 13px;">${alumni ? alumni.Department || 'N/A' : 'N/A'}</p>
              </div>
              <div style="text-align: right;">
                <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                  ${fb.Rating ? '‚≠ê'.repeat(fb.Rating) : 'No rating'}
                </span>
              </div>
            </div>
            <p style="margin: 8px 0 0 0; color: #475569; font-size: 14px; line-height: 1.6;">${fb.Comments || 'No comments'}</p>
            <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 12px;">${new Date(fb.FeedbackDate).toLocaleDateString()}</p>
          </div>
        `;
      });

      document.getElementById('detailModalTitle').textContent = `Class of ${year} - Feedback Details`;
      document.getElementById('detailModalContent').innerHTML = content;
      document.getElementById('detailModal').style.display = 'flex';
    }

    function showDeptDetail(dept, feedback, alumniMap) {
      const deptFeedback = feedback.filter(fb => {
        const alumni = alumniMap[fb.AlumniID];
        return alumni && alumni.Department === dept;
      });

      let content = `
        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 8px 0; color: #1d3557;">${dept} Department</h4>
          <p style="margin: 0; color: #64748b; font-size: 14px;">${deptFeedback.length} feedback submissions</p>
        </div>
      `;

      deptFeedback.slice(0, 10).forEach(fb => {
        const alumni = alumniMap[fb.AlumniID];
        content += `
          <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                <h5 style="margin: 0 0 4px 0; color: #1e293b; font-size: 15px;">${alumni ? `${alumni.FirstName} ${alumni.LastName}` : 'Anonymous'}</h5>
                <p style="margin: 0; color: #64748b; font-size: 13px;">Class of ${alumni ? alumni.GraduationYear || 'N/A' : 'N/A'}</p>
              </div>
              <div style="text-align: right;">
                <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                  ${fb.Rating ? '‚≠ê'.repeat(fb.Rating) : 'No rating'}
                </span>
              </div>
            </div>
            <p style="margin: 8px 0 0 0; color: #475569; font-size: 14px; line-height: 1.6;">${fb.Comments || 'No comments'}</p>
            <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 12px;">${new Date(fb.FeedbackDate).toLocaleDateString()}</p>
          </div>
        `;
      });

      document.getElementById('detailModalTitle').textContent = `${dept} - Feedback Details`;
      document.getElementById('detailModalContent').innerHTML = content;
      document.getElementById('detailModal').style.display = 'flex';
    }

    function showRatingDetail(rating, feedback, alumniMap) {
      const ratingFeedback = feedback.filter(fb => fb.Rating && parseInt(fb.Rating) === rating);

      const ratingLabels = {
        1: '1 Star',
        2: '2 Stars',
        3: '3 Stars',
        4: '4 Stars',
        5: '5 Stars'
      };

      let content = `
        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 8px 0; color: #1d3557;">${ratingLabels[rating]} Ratings</h4>
          <p style="margin: 0; color: #64748b; font-size: 14px;">${ratingFeedback.length} feedback submissions</p>
        </div>
      `;

      ratingFeedback.slice(0, 20).forEach(fb => {
        const alumni = alumniMap[fb.AlumniID];
        content += `
          <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                <h5 style="margin: 0 0 4px 0; color: #1e293b; font-size: 15px;">${alumni ? `${alumni.FirstName} ${alumni.LastName}` : 'Anonymous'}</h5>
                <p style="margin: 0; color: #64748b; font-size: 13px;">${alumni ? `${alumni.Department || 'N/A'} ‚Ä¢ Class of ${alumni.GraduationYear || 'N/A'}` : 'N/A'}</p>
              </div>
              <div style="text-align: right;">
                <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                  ${'‚≠ê'.repeat(rating)}
                </span>
                <button onclick="requestConnection('${fb.AlumniID}', '${alumni ? `${alumni.FirstName} ${alumni.LastName}` : 'Anonymous'}')" 
                        style="margin-top: 8px; padding: 6px 12px; background: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Connect
                </button>
              </div>
            </div>
            <p style="margin: 8px 0 0 0; color: #475569; font-size: 14px; line-height: 1.6;"><strong>Feedback:</strong> ${fb.Comments || 'No comments provided'}</p>
            <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 12px;">Submitted on ${new Date(fb.FeedbackDate).toLocaleDateString()}</p>
          </div>
        `;
      });

      if (ratingFeedback.length > 20) {
        content += `
          <p style="text-align: center; color: #64748b; font-size: 14px; margin-top: 16px;">
            Showing first 20 of ${ratingFeedback.length} feedback entries
          </p>
        `;
      }

      document.getElementById('detailModalTitle').textContent = `${ratingLabels[rating]} - Feedback Details`;
      document.getElementById('detailModalContent').innerHTML = content;
      document.getElementById('detailModal').style.display = 'flex';
    }

    function showRoleDetail(role, feedback, alumniMap, engagementMap) {
      let roleFeedback = [];

      feedback.forEach(fb => {
        const eng = engagementMap[fb.AlumniID];
        let fbRole = 'General Alumni';

        if (eng && (eng.events > 0 || eng.mentorships > 0 || eng.donations > 0)) {
          if (eng.mentorships > 0) {
            const isMentor = allMentorships.some(m => m.MentorAlumniID === fb.AlumniID);
            fbRole = isMentor ? 'Mentor' : 'Mentee';
          } else if (eng.donations > 0) {
            fbRole = 'Donor';
          } else if (eng.events > 0) {
            fbRole = 'Event Attendee';
          }
        }

        if (fbRole === role) {
          roleFeedback.push(fb);
        }
      });

      let content = `
        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 8px 0; color: #1d3557;">${role}</h4>
          <p style="margin: 0; color: #64748b; font-size: 14px;">${roleFeedback.length} feedback submissions</p>
        </div>
      `;

      roleFeedback.slice(0, 10).forEach(fb => {
        const alumni = alumniMap[fb.AlumniID];
        content += `
          <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                <h5 style="margin: 0 0 4px 0; color: #1e293b; font-size: 15px;">${alumni ? `${alumni.FirstName} ${alumni.LastName}` : 'Anonymous'}</h5>
                <p style="margin: 0; color: #64748b; font-size: 13px;">${alumni ? `${alumni.Department || 'N/A'} ‚Ä¢ Class of ${alumni.GraduationYear || 'N/A'}` : 'N/A'}</p>
              </div>
              <div style="text-align: right;">
                <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                  ${fb.Rating ? '‚≠ê'.repeat(fb.Rating) : 'No rating'}
                </span>
              </div>
            </div>
            <p style="margin: 8px 0 0 0; color: #475569; font-size: 14px; line-height: 1.6;">${fb.Comments || 'No comments'}</p>
            <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 12px;">${new Date(fb.FeedbackDate).toLocaleDateString()}</p>
          </div>
        `;
      });

      document.getElementById('detailModalTitle').textContent = `${role} - Feedback Details`;
      document.getElementById('detailModalContent').innerHTML = content;
      document.getElementById('detailModal').style.display = 'flex';
    }

    function closeDetailModal() {
      document.getElementById('detailModal').style.display = 'none';
    }

    // Connection request function
    function requestConnection(alumniId, alumniName) {
      // Store connection request in localStorage
      let connectionRequests = JSON.parse(localStorage.getItem('connectionRequests') || '[]');
      
      // Check if request already exists
      const existingRequest = connectionRequests.find(req => req.alumniId === alumniId);
      if (existingRequest) {
        alert(`You have already requested to connect with ${alumniName}.`);
        return;
      }
      
      // Add new request
      connectionRequests.push({
        alumniId: alumniId,
        alumniName: alumniName,
        requestDate: new Date().toISOString(),
        status: 'pending'
      });
      
      localStorage.setItem('connectionRequests', JSON.stringify(connectionRequests));
      alert(`You have requested to connect with ${alumniName}. If ${alumniName} approves, you will be notified.`);
    }

    // Deep Insights Modal
    function showDeepInsightsModal() {
      const modal = document.getElementById('deepInsightsModal');
      modal.style.display = 'flex';

      // Destroy existing charts
      Object.values(deepInsightsCharts).forEach(chart => {
        if (chart) chart.destroy();
      });
      deepInsightsCharts = {};

      // Build alumni map
      const alumniMap = {};
      allAlumni.forEach(alumni => {
        if (alumni.AlumniID) {
          alumniMap[alumni.AlumniID] = alumni;
        }
      });

      // Show all feedback in deep insights modal (no filtering)
      let filteredFeedback = allFeedback.filter(fb => {
        if (!fb.FeedbackDate) return false;
        const date = new Date(fb.FeedbackDate);
        return !isNaN(date.getTime());
      });

      // Insight 1: Top 5 Cohorts by Feedback Volume
      const cohortCounts = {};
      filteredFeedback.forEach(fb => {
        const alumni = alumniMap[fb.AlumniID];
        if (alumni && alumni.GraduationYear) {
          cohortCounts[alumni.GraduationYear] = (cohortCounts[alumni.GraduationYear] || 0) + 1;
        }
      });
      const topCohorts = Object.keys(cohortCounts).sort((a, b) => cohortCounts[b] - cohortCounts[a]).slice(0, 5);

      deepInsightsCharts.cohorts = new Chart(document.getElementById('topCohortsChart'), {
        type: 'bar',
        data: {
          labels: topCohorts,
          datasets: [{
            label: 'Feedback Count',
            data: topCohorts.map(cohort => cohortCounts[cohort]),
            backgroundColor: '#8b5cf6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });

      // Insight 2: Theme Frequency (derived from events, mentorships)
      const themeCounts = {
        'Events': filteredFeedback.filter(fb => fb.EventID).length,
        'Mentorship': filteredFeedback.filter(fb => fb.MentorshipID).length,
        'General': filteredFeedback.filter(fb => !fb.EventID && !fb.MentorshipID).length
      };

      deepInsightsCharts.theme = new Chart(document.getElementById('themeHeatmapChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(themeCounts),
          datasets: [{
            data: Object.values(themeCounts),
            backgroundColor: ['#0ea5e9', '#10b981', '#64748b']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
          }
        }
      });

      // Generate insights text
      const topCohort = topCohorts[0];
      const totalFeedbackCount = filteredFeedback.length;
      const uniqueContributors = new Set(filteredFeedback.map(fb => fb.AlumniID)).size;

      const insightsText = `
        <strong>Top Cohort:</strong> The class of ${topCohort} leads with ${cohortCounts[topCohort]} feedback submissions, representing the most vocal graduation year.
        <br><br>
        <strong>Contribution Pattern:</strong> ${uniqueContributors} alumni have contributed ${totalFeedbackCount} total feedback entries, showing active community participation.
        <br><br>
        <strong>Theme Distribution:</strong> ${themeCounts.Events} feedback entries are event-related, ${themeCounts.Mentorship} are mentorship-related, and ${themeCounts.General} are general feedback, showing where alumni focus their input.
      `;

      document.getElementById('deepInsightsText').innerHTML = insightsText;
    }

    function closeDeepInsightsModal() {
      document.getElementById('deepInsightsModal').style.display = 'none';
      Object.values(deepInsightsCharts).forEach(chart => {
        if (chart) chart.destroy();
      });
      deepInsightsCharts = {};
    }

    // Filter functions
    // Individual filter functions for each chart
    function applyGradYearFilter() {
      gradYearFilter.year = document.getElementById('gradYearFilterYear').value;
      gradYearFilter.month = document.getElementById('gradYearFilterMonth').value;
      renderAnalysis();
    }

    function resetGradYearFilter() {
      gradYearFilter.year = 'all';
      gradYearFilter.month = 'all';
      document.getElementById('gradYearFilterYear').value = 'all';
      document.getElementById('gradYearFilterMonth').value = 'all';
      renderAnalysis();
    }

    function applyDeptFilter() {
      deptFilter.year = document.getElementById('deptFilterYear').value;
      deptFilter.month = document.getElementById('deptFilterMonth').value;
      renderAnalysis();
    }

    function resetDeptFilter() {
      deptFilter.year = 'all';
      deptFilter.month = 'all';
      document.getElementById('deptFilterYear').value = 'all';
      document.getElementById('deptFilterMonth').value = 'all';
      renderAnalysis();
    }

    function applyRatingFilter() {
      ratingFilter.year = document.getElementById('ratingFilterYear').value;
      ratingFilter.month = document.getElementById('ratingFilterMonth').value;
      renderAnalysis();
    }

    function resetRatingFilter() {
      ratingFilter.year = 'all';
      ratingFilter.month = 'all';
      document.getElementById('ratingFilterYear').value = 'all';
      document.getElementById('ratingFilterMonth').value = 'all';
      renderAnalysis();
    }

    function applyRoleFilter() {
      roleFilter.year = document.getElementById('roleFilterYear').value;
      roleFilter.month = document.getElementById('roleFilterMonth').value;
      renderAnalysis();
    }

    function resetRoleFilter() {
      roleFilter.year = 'all';
      roleFilter.month = 'all';
      document.getElementById('roleFilterYear').value = 'all';
      document.getElementById('roleFilterMonth').value = 'all';
      renderAnalysis();
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const deepModal = document.getElementById('deepInsightsModal');
      const detailModal = document.getElementById('detailModal');
      if (event.target === deepModal) {
        closeDeepInsightsModal();
      }
      if (event.target === detailModal) {
        closeDetailModal();
      }
    };

    // Initialize
    initFeedbackAnalysis();
</script>

</body>
</html>
