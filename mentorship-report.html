<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mentorship Insights | Alumni Portal</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .report-wrapper {
      display: grid;
      gap: 24px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }
    .report-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.06);
    }
    .report-card h3 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #1d3557;
    }
    .stat {
      font-size: 28px;
      font-weight: 600;
      color: #14213d;
      margin: 0;
    }
    .stat-note {
      font-size: 14px;
      color: #475569;
      margin-top: 6px;
    }
    .chart-grid {
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    .chart-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.06);
    }
    .chart-card h4 {
      font-size: 14px;
      color: #475569;
      margin: 0 0 10px 0;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    canvas {
      width: 100%;
      height: auto;
    }
    .chart-note {
      margin-top: 12px;
      font-size: 14px;
      color: #475569;
    }
    .chart-actions {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .chart-actions button, .chart-actions a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--indigo-600), var(--indigo-500));
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 4px 12px rgba(11,61,145,0.25);
      transition: background 0.2s ease;
    }
    .chart-actions button:hover,
    .chart-actions a:hover {
      background: var(--indigo-700);
    }
    .chart-actions button.secondary,
    .chart-actions a.secondary {
      background: #10b981;
      box-shadow: 0 4px 12px rgba(16,185,129,0.18);
    }
    .chart-actions button.secondary:hover,
    .chart-actions a.secondary:hover {
      background: #059669;
    }
    .recommendation-list {
      list-style: disc;
      padding-left: 20px;
      color: #475569;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      text-decoration: none;
      color: #0b3d91;
      font-weight: 600;
    }
    .back-link:hover {
      color: #08306b;
    }
    .filter-section {
      background: #f8fafc;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .filter-section label {
      font-weight: 600;
      color: #475569;
      font-size: 14px;
    }
    .filter-section select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }
    .insight-card {
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      border-left: 4px solid #0b3d91;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .insight-card.warning {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left-color: #f59e0b;
    }
    .insight-card.success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-left-color: #10b981;
    }
    .insight-card h4 {
      margin: 0 0 8px 0;
      color: #1d3557;
      font-size: 16px;
    }
    .insight-card p {
      margin: 0;
      color: #475569;
      font-size: 14px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 12px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }
    .stat-item {
      text-align: center;
    }
    .stat-item label {
      display: block;
      font-size: 12px;
      color: #64748b;
      margin-bottom: 4px;
    }
    .stat-item value {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #1d3557;
    }
    .drilldown-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .drilldown-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .drilldown-content h3 {
      margin-top: 0;
      color: #1d3557;
    }
    .drilldown-content .close-btn {
      float: right;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
    }
    .drilldown-list {
      list-style: none;
      padding: 0;
      margin: 12px 0 0 0;
    }
    .drilldown-list li {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    .drilldown-list li:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <h2>Alumni Portal</h2>
    <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
    <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
    <a href="event-report.html"><i class="fas fa-chart-line"></i> Events</a>
    <a class="active" href="mentorship-report.html"><i class="fas fa-handshake"></i> Mentorship Report</a>
    <a href="donation-report.html"><i class="fas fa-bullseye"></i> Donations</a>
    <a href="feedback.html"><i class="fas fa-comment"></i> Feedback</a>
    <a href="logout.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <div class="main-content">
    <div class="report-wrapper">
      <div>
        <h1>Mentorship Insights</h1>
        <a class="back-link" href="dashboard.html"><i class="fas fa-arrow-left"></i>Back to dashboard</a>
      </div>

      <!-- Summary Statistics -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px;">
        <div style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); padding: 28px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h4 style="margin: 0 0 12px 0; color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Your Active Sessions</h4>
          <p style="margin: 0 0 8px 0; color: white; font-size: 36px; font-weight: 700;" id="myActiveSessions">0</p>
          <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 13px;" id="myActiveNote"></p>
        </div>
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 28px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h4 style="margin: 0 0 12px 0; color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Sessions Completed</h4>
          <p style="margin: 0 0 8px 0; color: white; font-size: 36px; font-weight: 700;" id="myCompletedSessions">0</p>
          <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 13px;" id="myCompletedNote"></p>
        </div>
        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 28px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h4 style="margin: 0 0 12px 0; color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Campus Active Pairings</h4>
          <p style="margin: 0 0 8px 0; color: white; font-size: 36px; font-weight: 700;" id="campusActive">0</p>
          <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 13px;" id="campusActiveNote"></p>
        </div>
        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 28px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h4 style="margin: 0 0 12px 0; color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Most Popular Focus</h4>
          <p style="margin: 0 0 8px 0; color: white; font-size: 28px; font-weight: 700;" id="topFocus">-</p>
          <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 13px;" id="topFocusNote"></p>
        </div>
      </div>

      <div class="chart-card" style="margin-bottom: 24px;">
        <h3>Mentorship Sessions by Focus Area</h3>
          <h4 id="focusChartHighlight">Top focus areas</h4>
          
          <!-- Filter Section -->
          <div class="filter-section" style="margin-bottom: 16px;">
            <label for="focusAreaFilterYear">Year:</label>
            <select id="focusAreaFilterYear">
              <option value="all">All Years</option>
            </select>
            
            <label for="focusAreaFilterMonth">Month:</label>
            <select id="focusAreaFilterMonth">
              <option value="all">All Months</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            
            <button onclick="applyFocusAreaFilter()">Apply</button>
            <button onclick="resetFocusAreaFilter()">Reset</button>
          </div>
          
          <canvas id="focusAreaChart"></canvas>
          <p class="chart-note" id="focusChartNote" style="font-size: 12px; color: #64748b; margin-top: 8px;">Click a bar to see mentor and mentee lists for that focus area</p>
          <div class="chart-actions">
            <button id="focusChartCTA"><i class="fas fa-user-plus"></i><span>Volunteer in this focus</span></button>
            <button class="secondary" id="focusInviteCTA"><i class="fas fa-share-alt"></i><span>Invite a peer mentor</span></button>
          </div>
      </div>
      
      <div class="chart-card" style="margin-bottom: 24px;">
        <h3>Mentorship Starts by Month</h3>
          <h4>Seasonal momentum</h4>
          
          <!-- Filter Section -->
          <div class="filter-section" style="margin-bottom: 16px;">
            <label for="startsFilterYear">Year:</label>
            <select id="startsFilterYear">
              <option value="all">All Years</option>
            </select>
            
            <label for="startsFilterMonth">Month:</label>
            <select id="startsFilterMonth">
              <option value="all">All Months</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            
            <button onclick="applyStartsFilter()">Apply</button>
            <button onclick="resetStartsFilter()">Reset</button>
          </div>
          
          <canvas id="startMonthChart" style="cursor: pointer;"></canvas>
          <p class="chart-note" id="startMonthNote" style="font-size: 12px; color: #64748b; margin-top: 8px;">Includes 3-month moving average trendline ¬∑ <strong style="color: #0ea5e9; cursor: pointer;">Click for deeper analysis</strong></p>
          <div class="chart-actions">
            <button id="startsCTA"><i class="fas fa-bullhorn"></i><span>Promote next cohort</span></button>
          </div>
      </div>
      
      <div class="chart-card" style="margin-bottom: 24px;">
        <h3>Mentee Graduation Year Distribution</h3>
          <h4 id="gradYearSubtitle">Who mentees are today</h4>
          
          <!-- Filter Section -->
          <div class="filter-section" style="margin-bottom: 16px;">
            <label for="gradYearFilterMonth">Month:</label>
            <select id="gradYearFilterMonth">
              <option value="all">All Months</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            
            <button onclick="applyGradYearFilter()">Apply</button>
            <button onclick="resetGradYearFilter()">Reset</button>
          </div>
          
          <canvas id="gradYearChart" style="cursor: pointer;"></canvas>
          <p class="chart-note" id="gradYearNote"></p>
          <div class="chart-actions">
            <button id="gradYearCTA"><i class="fas fa-users"></i><span>Support this class</span></button>
          </div>
      </div>

      <div class="report-card">
        <h3>Recommendations</h3>
        <ul class="recommendation-list" id="mentorshipRecommendations"></ul>
      </div>

      </div>
  </div>
</div>

<div class="drilldown-modal" id="drilldownModal">
  <div class="drilldown-content" style="max-width: 700px;">
    <button class="close-btn" onclick="closeDrilldown()">&times;</button>
    <h3 id="drilldownTitle" style="color: #1d3557; margin-bottom: 20px;">Mentorship Details</h3>
    
    <!-- Mentorship Gap Summary -->
    <div id="gapSummary" style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;"></div>
    
    <!-- Why This Focus Area Matters -->
    <div id="focusDescription" style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;"></div>
    
    <!-- Mini Chart -->
    <div id="miniChartContainer" style="margin-bottom: 20px; background: #ffffff; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
      <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #475569; font-weight: 600;">Supply vs Demand</h4>
      <canvas id="miniSupplyDemandChart" style="max-height: 200px;"></canvas>
      <p id="miniChartLabel" style="margin: 8px 0 0 0; font-size: 13px; color: #64748b; text-align: center;"></p>
    </div>
    
    <!-- Mentor and Mentee Lists -->
    <ul class="drilldown-list" id="drilldownList"></ul>
    
    <!-- Action Buttons -->
    <div class="chart-actions" style="margin-top: 20px; justify-content: center;">
      <button onclick="window.location.href='request-mentor.html'" style="flex: 1; justify-content: center;">
        <i class="fas fa-user-plus"></i>
        <span>Volunteer in this Focus</span>
      </button>
      <button class="secondary" onclick="alert('Share this focus area with peers who can help mentor!')" style="flex: 1; justify-content: center;">
        <i class="fas fa-share-alt"></i>
        <span>Invite a Peer Mentor</span>
      </button>
    </div>
    <p style="margin: 12px 0 0 0; font-size: 12px; color: #64748b; text-align: center;">
      <em>Volunteering helps fill mentorship gaps and strengthens the community.</em>
    </p>
  </div>
</div>

<!-- Mentorship Starts Analysis Modal -->
<div class="drilldown-modal" id="startsAnalysisModal">
  <div class="drilldown-content" style="max-width: 900px;">
    <button class="close-btn" onclick="closeStartsAnalysisModal()">&times;</button>
    <h3 style="color: #1d3557; margin-bottom: 20px;">Mentorship Starts - Deeper Analysis</h3>
    
    <!-- Three Charts in a Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
      <!-- Bar Chart: Monthly Highs & Lows -->
      <div style="background: #ffffff; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #475569; font-weight: 600;">Monthly Highs & Lows</h4>
        <canvas id="monthlyHighsLowsChart" style="max-height: 220px;"></canvas>
      </div>
      
      <!-- Donut Chart: Seasonal Patterns -->
      <div style="background: #ffffff; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #475569; font-weight: 600;">Seasonal Patterns</h4>
        <canvas id="seasonalPatternsChart" style="max-height: 220px;"></canvas>
      </div>
      
      <!-- Line Chart: Recruitment Drop-Off -->
      <div style="background: #ffffff; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #475569; font-weight: 600;">Recruitment Drop-Off</h4>
        <canvas id="dropOffChart" style="max-height: 220px;"></canvas>
      </div>
    </div>
    
    <!-- Analysis Text -->
    <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
      <h4 style="margin: 0 0 12px 0; font-size: 15px; color: #0c4a6e; font-weight: 600;">What This Data Reveals</h4>
      <p id="startsAnalysisText" style="margin: 0; font-size: 14px; color: #475569; line-height: 1.8;"></p>
    </div>
  </div>
</div>

<!-- Mentee Graduation Year Analysis Modal -->
<div class="drilldown-modal" id="gradYearAnalysisModal">
  <div class="drilldown-content" style="max-width: 900px;">
    <button class="close-btn" onclick="closeGradYearAnalysisModal()">&times;</button>
    <h3 style="color: #1d3557; margin-bottom: 20px;">Mentee Graduation Cohort Analysis</h3>
    
    <!-- Line Chart: Cohort Trend -->
    <div style="background: #ffffff; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 12px;">
      <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #475569; font-weight: 600;">Cohort Trend Line</h4>
      <canvas id="gradYearLineChart" style="max-height: 320px; cursor: pointer;"></canvas>
    </div>
    
    <!-- Hint Text -->
    <p style="text-align: center; color: #64748b; font-size: 12px; margin: 0 0 20px 0;">
      <i class="fas fa-info-circle"></i> Click on any year in the chart above to view detailed mentee profiles
    </p>
    
    <!-- Dynamic Insights Text -->
    <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
      <h4 style="margin: 0 0 12px 0; font-size: 15px; color: #0c4a6e; font-weight: 600;">Cohort Insights</h4>
      <p id="gradYearInsightsText" style="margin: 0; font-size: 14px; color: #475569; line-height: 1.8;"></p>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let allMentorshipRows = [];
  let allAlumniRows = [];
  let currentFilteredMentorships = []; // Store filtered mentorship data for modals
  let chartInstances = {};
  let currentModalData = {}; // Store current focus area data for drill-down
  let startsAnalysisCharts = {}; // Store chart instances for starts analysis modal
  let gradYearAnalysisCharts = {}; // Store chart instances for grad year analysis modal
  let gradYearAnalysisData = {}; // Store grad year data for modal
  let gradYearFilter = { month: 'all' }; // Filter for grad year chart
  let focusAreaFilter = { year: 'all', month: 'all' }; // Filter for focus area chart
  let startsFilter = { year: 'all', month: 'all' }; // Filter for starts by month chart

  function loadCSV(path) {
    return new Promise((resolve, reject) => {
      Papa.parse(path, {
        download: true,
        header: true,
        complete: results => resolve(results.data.filter(row => Object.values(row).some(v => v))),
        error: reject
      });
    });
  }

  function parseDate(value) {
    if (!value) return null;
    const direct = new Date(value);
    if (!isNaN(direct)) return direct;
    const parts = value.split("/");
    if (parts.length === 3) {
      const dt = new Date(parseInt(parts[2], 10), parseInt(parts[0], 10) - 1, parseInt(parts[1], 10));
      return isNaN(dt) ? null : dt;
    }
    return null;
  }

  function monthKey(date) {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
  }

  function calculateMovingAverage(data, window = 3) {
    const result = [];
    for (let i = 0; i < data.length; i++) {
      const start = Math.max(0, i - window + 1);
      const windowData = data.slice(start, i + 1);
      const avg = windowData.reduce((sum, val) => sum + val, 0) / windowData.length;
      result.push(avg);
    }
    return result;
  }

  // Focus area descriptions
  const focusDescriptions = {
    'Leadership': 'Alumni often seek guidance on leadership growth and career direction.',
    'Networking': 'Popular for alumni wanting professional connections or industry exposure.',
    'Entrepreneurship': 'High demand from alumni launching businesses or exploring startups.',
    'Career Guidance': 'Useful for job seekers navigating transitions or promotions.',
    'Graduate School Prep': 'Requested by alumni preparing for further studies.',
    'Software Engineering': 'High-interest technical field needing strong mentor support.',
    'Data Science': 'Growing field with strong demand for technical mentorship.',
    'Product Management': 'Alumni seeking guidance on product strategy and management.',
    'Design': 'Creative professionals looking for portfolio and career advice.',
    'Marketing': 'Professionals seeking strategic marketing and branding guidance.'
  };

  let miniChartInstance = null;

  function showMentorDetails() {
    const focusArea = currentModalData.focusArea;
    
    // Use filtered data to respect year filter
    const dataSource = currentFilteredMentorships.length > 0 ? currentFilteredMentorships : allMentorshipRows;
    
    // Get unique mentors in this focus area
    const mentorIds = new Set();
    dataSource.forEach(row => {
      if (row.FocusArea === focusArea && row.MentorAlumniID) {
        mentorIds.add(row.MentorAlumniID);
      }
    });
    
    // Build alumni map
    const alumniMap = {};
    allAlumniRows.forEach(row => {
      if (row.AlumniID) {
        alumniMap[row.AlumniID] = row;
      }
    });
    
    // Calculate mentees per mentor (from filtered data)
    const mentorMenteeCount = {};
    dataSource.forEach(row => {
      if (row.MentorAlumniID) {
        mentorMenteeCount[row.MentorAlumniID] = (mentorMenteeCount[row.MentorAlumniID] || 0) + 1;
      }
    });
    
    let html = `
      <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #10b981;">
        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: #047857;">üë®‚Äçüè´ Mentors in ${focusArea}</h4>
        <p style="margin: 0; font-size: 13px; color: #475569;">Detailed mentor profiles with their experience and availability</p>
      </div>
    `;
    
    if (mentorIds.size === 0) {
      html += '<p style="color: #64748b; text-align: center; padding: 20px;">No mentors found in this focus area.</p>';
    } else {
      mentorIds.forEach(mentorId => {
        const alumni = alumniMap[mentorId];
        
        if (alumni) {
          const menteeCount = mentorMenteeCount[mentorId] || 0;
          const name = `${alumni.FirstName || ''} ${alumni.LastName || ''}`.trim() || 'Unknown Mentor';
          const gradYear = alumni.GraduationYear || 'N/A';
          const dept = alumni.Department || 'N/A';
          const job = alumni.Occupation || alumni.CurrentJob || 'Not specified';
          
          html += `
            <div style="background: #ffffff; padding: 14px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <h5 style="margin: 0; color: #1d3557; font-size: 15px; font-weight: 600;">${name}</h5>
                <span onclick="showMentorMentees('${mentorId}', '${name.replace(/'/g, "\\'")}', '${focusArea}')" style="background: #10b981; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                  ${menteeCount} ${menteeCount === 1 ? 'Mentee' : 'Mentees'} ‚Üí
                </span>
              </div>
              <div style="font-size: 13px; color: #475569; line-height: 1.8;">
                <p style="margin: 4px 0;"><strong>Graduation Year:</strong> ${gradYear}</p>
                <p style="margin: 4px 0;"><strong>Department:</strong> ${dept}</p>
                <p style="margin: 4px 0;"><strong>Current Job:</strong> ${job}</p>
              </div>
            </div>
          `;
        }
      });
    }
    
    html += `
      <button onclick="showMainModal()" style="width: 100%; margin-top: 12px; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
        ‚Üê Back to ${focusArea} Overview
      </button>
    `;
    
    document.getElementById('drilldownList').innerHTML = html;
    document.getElementById('gapSummary').style.display = 'none';
    document.getElementById('focusDescription').style.display = 'none';
    document.getElementById('miniChartContainer').style.display = 'none';
    document.querySelector('.chart-actions').style.display = 'none';
    document.getElementById('drilldownTitle').textContent = `${focusArea} ‚Äì Mentor Profiles`;
  }
  
  function showMenteeDetails() {
    const focusArea = currentModalData.focusArea;
    const mentorCount = currentModalData.mentorCount;
    const menteeCount = currentModalData.menteeCount;
    const gap = menteeCount - mentorCount;
    
    // Use filtered data to respect year filter
    const dataSource = currentFilteredMentorships.length > 0 ? currentFilteredMentorships : allMentorshipRows;
    
    // Get all mentees in this focus area
    const menteeIds = [];
    dataSource.forEach(row => {
      if (row.FocusArea === focusArea && row.MenteeAlumniID) {
        if (!menteeIds.includes(row.MenteeAlumniID)) {
          menteeIds.push(row.MenteeAlumniID);
        }
      }
    });
    
    // Build alumni map
    const alumniMap = {};
    allAlumniRows.forEach(row => {
      if (row.AlumniID) {
        alumniMap[row.AlumniID] = row;
      }
    });
    
    // LOGIC: If gap > 0 (more mentees than mentors), then gap number of mentees MUST be unmatched
    const menteesWithMentors = new Set();
    
    if (gap > 0) {
      // Only mentor supply number of mentees can be matched
      // The rest (gap number) must be unmatched
      const maxMatched = mentorCount;
      let matchedCount = 0;
      
      dataSource.forEach(row => {
        if (row.FocusArea === focusArea && row.MenteeAlumniID && row.MentorAlumniID && matchedCount < maxMatched) {
          menteesWithMentors.add(row.MenteeAlumniID);
          matchedCount++;
        }
      });
    } else {
      // If there are enough mentors or equal, all mentees can be matched
      dataSource.forEach(row => {
        if (row.FocusArea === focusArea && row.MenteeAlumniID && row.MentorAlumniID) {
          menteesWithMentors.add(row.MenteeAlumniID);
        }
      });
    }
    
    // Sort mentees: unmatched first, then matched
    const sortedMentees = menteeIds.sort((a, b) => {
      const aHasMentor = menteesWithMentors.has(a);
      const bHasMentor = menteesWithMentors.has(b);
      
      // Unmatched (false) should come before matched (true)
      if (aHasMentor === bHasMentor) return 0;
      return aHasMentor ? 1 : -1;
    });
    
    // Count unmatched mentees
    const unmatchedCount = menteeIds.filter(id => !menteesWithMentors.has(id)).length;
    
    let html = `
      <div style="background: #eff6ff; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: #1e40af;">üéì All Mentees in ${focusArea}</h4>
        <p style="margin: 0; font-size: 13px; color: #475569;">
          ${unmatchedCount > 0 
            ? `<strong style="color: #ef4444;">${unmatchedCount} unmatched</strong> ¬∑ ${sortedMentees.length - unmatchedCount} matched` 
            : 'All mentees are currently matched with mentors! üéâ'}
        </p>
      </div>
    `;
    
    if (sortedMentees.length === 0) {
      html += '<p style="color: #64748b; text-align: center; padding: 20px;">No mentees found in this focus area.</p>';
    } else {
      sortedMentees.forEach(menteeId => {
        const alumni = alumniMap[menteeId];
        
        if (alumni) {
          const hasMentor = menteesWithMentors.has(menteeId);
          const name = `${alumni.FirstName || ''} ${alumni.LastName || ''}`.trim() || 'Unknown Mentee';
          const gradYear = alumni.GraduationYear || 'N/A';
          const dept = alumni.Department || 'N/A';
          const job = alumni.Occupation || alumni.CurrentJob || 'Position not specified';
          
          html += `
            <div style="background: ${!hasMentor ? '#fef3c7' : '#ffffff'}; padding: 14px; margin-bottom: 12px; border-radius: 8px; border: 1px solid ${!hasMentor ? '#fcd34d' : '#e2e8f0'}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <h5 style="margin: 0; color: #1d3557; font-size: 15px; font-weight: 600;">
                  ${!hasMentor ? '‚ö†Ô∏è ' : ''}${name}
                </h5>
                <span style="background: ${hasMentor ? '#10b981' : '#ef4444'}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                  ${hasMentor ? 'Matched' : 'Unmatched'}
                </span>
              </div>
              <div style="font-size: 13px; color: #475569; line-height: 1.8;">
                <p style="margin: 4px 0;"><strong>Graduation Year:</strong> ${gradYear}</p>
                <p style="margin: 4px 0;"><strong>Department:</strong> ${dept}</p>
                <p style="margin: 4px 0;"><strong>Current Position:</strong> ${job}</p>
              </div>
              ${!hasMentor ? `
                <button onclick="requestToMentor('${menteeId}', '${name.replace(/'/g, "\\'")}')" style="width: 100%; margin-top: 10px; padding: 8px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                  <i class="fas fa-handshake"></i> Offer to Mentor ${name.split(' ')[0]}
                </button>
              ` : ''}
            </div>
          `;
        }
      });
    }
    
    html += `
      <button onclick="showMainModal()" style="width: 100%; margin-top: 12px; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
        ‚Üê Back to ${focusArea} Overview
      </button>
    `;
    
    document.getElementById('drilldownList').innerHTML = html;
    document.getElementById('gapSummary').style.display = 'none';
    document.getElementById('focusDescription').style.display = 'none';
    document.getElementById('miniChartContainer').style.display = 'none';
    document.querySelector('.chart-actions').style.display = 'none';
    document.getElementById('drilldownTitle').textContent = `${focusArea} ‚Äì Mentee Profiles`;
  }
  
  function showMainModal() {
    // Restore main modal view
    document.getElementById('gapSummary').style.display = 'block';
    document.getElementById('focusDescription').style.display = 'block';
    document.getElementById('miniChartContainer').style.display = 'block';
    document.querySelector('.chart-actions').style.display = 'flex';
    document.getElementById('drilldownTitle').textContent = `${currentModalData.focusArea} ‚Äì Mentorship Insights`;
    
    // Restore original list
    const mentors = currentModalData.mentors || [];
    const mentees = currentModalData.mentees || [];
    const items = [
      '<strong style="font-size: 15px; color: #1d3557;">üë®‚Äçüè´ Mentors Available:</strong>',
      ...(mentors.length > 0 ? mentors.map(m => `  ‚Ä¢ ${m}`) : ['  <em style="color: #64748b;">None listed</em>']),
      '<br><strong style="font-size: 15px; color: #1d3557;">üéì Mentees Seeking Guidance:</strong>',
      ...(mentees.length > 0 ? mentees.map(m => `  ‚Ä¢ ${m}`) : ['  <em style="color: #64748b;">None listed</em>'])
    ];
    document.getElementById('drilldownList').innerHTML = items.map(item => `<li>${item}</li>`).join('');
  }
  
  function requestConnection(alumniId, alumniName) {
    const currentEmail = localStorage.getItem("loggedInUser") || "";
    const connections = JSON.parse(localStorage.getItem(`connectionRequests:${currentEmail}`) || "[]");
    
    // Check if already requested
    const alreadyRequested = connections.some(req => req.alumniId === alumniId);
    if (alreadyRequested) {
      alert(`You have already requested to connect with ${alumniName}.`);
      return;
    }
    
    connections.push({
      alumniId: alumniId,
      alumniName: alumniName,
      date: new Date().toISOString(),
      status: 'pending'
    });
    localStorage.setItem(`connectionRequests:${currentEmail}`, JSON.stringify(connections));
    
    alert(`You have requested to connect with ${alumniName}. If ${alumniName} approves, you will be notified.`);
  }
  
  function requestToMentor(menteeId, menteeName) {
    const requests = JSON.parse(localStorage.getItem('mentorshipRequests') || '[]');
    requests.push({
      menteeId: menteeId,
      menteeName: menteeName,
      focusArea: currentModalData.focusArea,
      date: new Date().toISOString(),
      status: 'pending'
    });
    localStorage.setItem('mentorshipRequests', JSON.stringify(requests));
    
    // Store selected mentee info for the mentorship page
    localStorage.setItem('selectedMentee', JSON.stringify({
      id: menteeId,
      name: menteeName,
      focusArea: currentModalData.focusArea
    }));
    
    // Redirect to mentorship request page
    window.location.href = 'request-mentor.html';
  }
  
  function offerToMentor(menteeId, menteeName, focusArea) {
    const offers = JSON.parse(localStorage.getItem('mentorshipOffers') || '[]');
    offers.push({
      menteeId: menteeId,
      menteeName: menteeName,
      focusArea: focusArea,
      date: new Date().toISOString(),
      status: 'pending'
    });
    localStorage.setItem('mentorshipOffers', JSON.stringify(offers));
    
    // Store selected mentee info for the mentorship page
    localStorage.setItem('selectedMentee', JSON.stringify({
      id: menteeId,
      name: menteeName,
      focusArea: focusArea
    }));
    
    // Redirect to mentorship request page
    window.location.href = 'request-mentor.html';
  }
  
  function showMentorMentees(mentorId, mentorName, focusArea) {
    // Get mentees assigned to this mentor (use filtered data to respect year filter)
    const menteeIds = [];
    const dataSource = currentFilteredMentorships.length > 0 ? currentFilteredMentorships : allMentorshipRows;
    dataSource.forEach(row => {
      if (row.MentorAlumniID === mentorId && row.FocusArea === focusArea) {
        menteeIds.push(row.MenteeAlumniID);
      }
    });
    
    // Build alumni map
    const alumniMap = {};
    allAlumniRows.forEach(row => {
      if (row.AlumniID) {
        alumniMap[row.AlumniID] = row;
      }
    });
    
    let html = `
      <div style="background: #eff6ff; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: #1e40af;">üéì Mentees of ${mentorName}</h4>
        <p style="margin: 0; font-size: 13px; color: #475569;">These mentees are currently being mentored by ${mentorName} in ${focusArea}</p>
      </div>
    `;
    
    if (menteeIds.length === 0) {
      html += '<p style="color: #64748b; text-align: center; padding: 20px;">No mentees assigned to this mentor yet.</p>';
    } else {
      menteeIds.forEach(menteeId => {
        const alumni = alumniMap[menteeId];
        
        if (alumni) {
          const name = `${alumni.FirstName || ''} ${alumni.LastName || ''}`.trim() || 'Unknown Mentee';
          const gradYear = alumni.GraduationYear || 'N/A';
          const dept = alumni.Department || 'N/A';
          const job = alumni.Occupation || alumni.CurrentJob || 'Position not specified';
          
          // Get mentorship details (use filtered data to respect year filter)
          const mentorship = dataSource.find(row => 
            row.MentorAlumniID === mentorId && row.MenteeAlumniID === menteeId
          );
          const status = mentorship ? mentorship.MentorshipStatus : 'Unknown';
          const startDate = mentorship && mentorship.StartDate ? new Date(mentorship.StartDate).toLocaleDateString() : 'N/A';
          
          html += `
            <div style="background: #ffffff; padding: 14px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <h5 style="margin: 0; color: #1d3557; font-size: 15px; font-weight: 600;">${name}</h5>
                <span style="background: ${status === 'Active' ? '#10b981' : '#94a3b8'}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                  ${status}
                </span>
              </div>
              <div style="font-size: 13px; color: #475569; line-height: 1.8;">
                <p style="margin: 4px 0;"><strong>Graduation Year:</strong> ${gradYear}</p>
                <p style="margin: 4px 0;"><strong>Department:</strong> ${dept}</p>
                <p style="margin: 4px 0;"><strong>Current Position:</strong> ${job}</p>
                <p style="margin: 4px 0;"><strong>Mentorship Started:</strong> ${startDate}</p>
              </div>
            </div>
          `;
        }
      });
    }
    
    html += `
      <button onclick="showMentorDetails()" style="width: 100%; margin-top: 12px; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
        ‚Üê Back to All Mentors
      </button>
    `;
    
    document.getElementById('drilldownList').innerHTML = html;
    document.getElementById('drilldownTitle').textContent = `${focusArea} ‚Äì ${mentorName}'s Mentees`;
  }

  function showDrilldown(focusArea, mentorCount, menteeCount, mentors, mentees) {
    const modal = document.getElementById('drilldownModal');
    const titleEl = document.getElementById('drilldownTitle');
    const listEl = document.getElementById('drilldownList');
    const gapSummaryEl = document.getElementById('gapSummary');
    const focusDescEl = document.getElementById('focusDescription');
    const miniChartLabelEl = document.getElementById('miniChartLabel');
    
    // Store current modal data for drill-down
    currentModalData = {
      focusArea: focusArea,
      mentorCount: mentorCount,
      menteeCount: menteeCount,
      mentors: mentors,
      mentees: mentees
    };
    
    // Set title
    titleEl.textContent = `${focusArea} ‚Äì Mentorship Insights`;
    
    // Build Gap Summary
    const gap = menteeCount - mentorCount;
    let gapInsight = '';
    if (gap > 0) {
      gapInsight = `This area has ${gap} more ${gap === 1 ? 'mentee' : 'mentees'} than ${gap === 1 ? 'mentor' : 'mentors'}. Alumni are encouraged to volunteer to support this high-demand focus area.`;
    } else if (gap < 0) {
      gapInsight = `This area has ${Math.abs(gap)} more ${Math.abs(gap) === 1 ? 'mentor' : 'mentors'} than ${Math.abs(gap) === 1 ? 'mentee' : 'mentees'}. Consider promoting this area to mentees who could benefit from available mentors.`;
    } else {
      gapInsight = 'This area is balanced with equal mentor supply and mentee demand.';
    }
    
    gapSummaryEl.innerHTML = `
      <h4 style="margin: 0 0 8px 0; font-size: 15px; color: #1d3557;">üìä Mentorship Gap Summary</h4>
      <p style="margin: 4px 0; font-size: 14px; color: #334155;"><strong>Mentor Supply:</strong> ${mentorCount} ${mentorCount === 1 ? 'mentor' : 'mentors'}</p>
      <p style="margin: 4px 0; font-size: 14px; color: #334155;"><strong>Mentee Demand:</strong> ${menteeCount} ${menteeCount === 1 ? 'mentee' : 'mentees'}</p>
      <p style="margin: 8px 0 0 0; font-size: 14px; color: #475569; line-height: 1.5;"><strong>Insight:</strong> ${gapInsight}</p>
    `;
    gapSummaryEl.style.display = 'block';
    
    // Build Focus Description
    const description = focusDescriptions[focusArea] || 'This focus area supports alumni in their professional development journey.';
    focusDescEl.innerHTML = `
      <h4 style="margin: 0 0 8px 0; font-size: 15px; color: #1d3557;">üí° Why This Focus Area Matters</h4>
      <p style="margin: 0; font-size: 14px; color: #334155; line-height: 1.5;">${description}</p>
    `;
    focusDescEl.style.display = 'block';
    
    // Build Mini Chart
    const canvas = document.getElementById('miniSupplyDemandChart');
    if (canvas) {
      // Destroy previous chart if exists
      if (miniChartInstance) {
        miniChartInstance.destroy();
        miniChartInstance = null;
      }
      
      miniChartInstance = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: ['Mentor Supply', 'Mentee Demand'],
          datasets: [{
            data: [mentorCount, menteeCount],
            backgroundColor: ['#10b981', '#3b82f6'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.parsed.y + (context.dataIndex === 0 ? ' mentors' : ' mentees');
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              if (index === 0) {
                // Clicked on Mentor Supply
                showMentorDetails();
              } else {
                // Clicked on Mentee Demand
                showMenteeDetails();
              }
            }
          }
        }
      });
      
      // Set chart label with click instruction
      if (gap > 5) {
        miniChartLabelEl.innerHTML = '‚ö†Ô∏è Biggest Gap ‚Äì High Mentor Demand<br><span style="font-size: 11px; color: #94a3b8;">Click bars to see detailed profiles</span>';
        miniChartLabelEl.style.color = '#dc2626';
      } else if (gap < -5) {
        miniChartLabelEl.innerHTML = '‚úÖ Mentor Surplus ‚Äì Promote to Mentees<br><span style="font-size: 11px; color: #94a3b8;">Click bars to see detailed profiles</span>';
        miniChartLabelEl.style.color = '#10b981';
      } else {
        miniChartLabelEl.innerHTML = '‚öñÔ∏è Balanced Area ‚Äì Supply Meets Demand<br><span style="font-size: 11px; color: #94a3b8;">Click bars to see detailed profiles</span>';
        miniChartLabelEl.style.color = '#3b82f6';
      }
      
      document.getElementById('miniChartContainer').style.display = 'block';
    }
    
    // Build mentor and mentee lists
    const items = [
      '<strong style="font-size: 15px; color: #1d3557;">üë®‚Äçüè´ Mentors Available:</strong>',
      ...(mentors.length > 0 ? mentors.map(m => `  ‚Ä¢ ${m}`) : ['  <em style="color: #64748b;">None listed</em>']),
      '<br><strong style="font-size: 15px; color: #1d3557;">üéì All Mentees:</strong>',
      ...(mentees.length > 0 ? mentees.map(m => `  ‚Ä¢ ${m}`) : ['  <em style="color: #64748b;">None listed</em>'])
    ];
    listEl.innerHTML = items.map(item => `<li>${item}</li>`).join('');
    
    // Add Unmatched Mentees Section if there's a gap
    if (gap > 0) {
      // Get unmatched mentees in this focus area
      const unmatchedMentees = [];
      const matchedMenteeIds = new Set();
      
      // Find which mentees have mentors
      allMentorshipRows.forEach(row => {
        if (row.FocusArea === focusArea && row.MenteeAlumniID && row.MentorAlumniID) {
          matchedMenteeIds.add(row.MenteeAlumniID);
        }
      });
      
      // Find unmatched mentees
      const alumniMap = {};
      allAlumniRows.forEach(row => {
        if (row.AlumniID) alumniMap[row.AlumniID] = row;
      });
      
      allMentorshipRows.forEach(row => {
        if (row.FocusArea === focusArea && row.MenteeAlumniID && !matchedMenteeIds.has(row.MenteeAlumniID)) {
          if (!unmatchedMentees.find(m => m.id === row.MenteeAlumniID)) {
            const alumni = alumniMap[row.MenteeAlumniID];
            if (alumni) {
              unmatchedMentees.push({
                id: row.MenteeAlumniID,
                name: `${alumni.FirstName || ''} ${alumni.LastName || ''}`.trim() || 'Unknown',
                gradYear: alumni.GraduationYear || 'N/A',
                dept: alumni.Department || 'N/A',
                job: alumni.Occupation || 'Not specified'
              });
            }
          }
        }
      });
      
      if (unmatchedMentees.length > 0) {
        let unmatchedHtml = `
          <div style="margin-top: 20px; padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <h4 style="margin: 0 0 8px 0; font-size: 15px; color: #92400e;">‚ö†Ô∏è ${unmatchedMentees.length} Unmatched ${unmatchedMentees.length === 1 ? 'Mentee' : 'Mentees'} in ${focusArea}</h4>
            <p style="margin: 0 0 12px 0; font-size: 13px; color: #78350f;">These mentees are waiting for mentors. Click "Offer to Mentor" to help!</p>
        `;
        
        unmatchedMentees.forEach(mentee => {
          unmatchedHtml += `
            <div style="background: #ffffff; padding: 12px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #fcd34d; display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <h5 style="margin: 0 0 4px 0; color: #1d3557; font-size: 14px; font-weight: 600;">${mentee.name}</h5>
                <div style="font-size: 12px; color: #64748b; line-height: 1.5;">
                  <span><strong>Dept:</strong> ${mentee.dept}</span> ¬∑ 
                  <span><strong>Class of</strong> ${mentee.gradYear}</span> ¬∑ 
                  <span>${mentee.job}</span>
                </div>
              </div>
              <button onclick="offerToMentor('${mentee.id}', '${mentee.name.replace(/'/g, "\\'")}', '${focusArea}')" style="padding: 8px 14px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap; margin-left: 12px;">
                <i class="fas fa-handshake"></i> Offer to Mentor
              </button>
            </div>
          `;
        });
        
        unmatchedHtml += '</div>';
        listEl.innerHTML += unmatchedHtml;
      }
    }
    
    // Show action buttons
    const actionsEl = document.querySelector('.chart-actions');
    if (actionsEl) actionsEl.style.display = 'flex';
    
    modal.style.display = 'flex';
  }

  function closeDrilldown() {
    const modal = document.getElementById('drilldownModal');
    modal.style.display = 'none';
    
    // Reset z-index to default
    modal.style.zIndex = '';
    
    // Destroy mini chart when closing
    if (miniChartInstance) {
      miniChartInstance.destroy();
      miniChartInstance = null;
    }
  }
  

  function filterMentorship(rows, alumniMap) {
    // No filtering - return all rows
    return rows;
  }

  async function initMentorshipReport() {
    const [mentorshipRows, alumniRows] = await Promise.all([
      loadCSV("./data/Mentorship.csv"),
      loadCSV("./data/Alumni.csv")
    ]);

    allMentorshipRows = mentorshipRows;
    allAlumniRows = alumniRows;
    
    // Populate filter year dropdowns with all available years from StartDate
    const yearsSet = new Set();
    allMentorshipRows.forEach(row => {
      if (row.StartDate) {
        const startDate = new Date(row.StartDate);
        if (!isNaN(startDate.getTime())) {
          yearsSet.add(startDate.getFullYear());
        }
      }
    });
    const sortedYears = Array.from(yearsSet).sort((a, b) => b - a);
    
    // Populate Focus Area filter
    const focusAreaYearSelect = document.getElementById('focusAreaFilterYear');
    if (focusAreaYearSelect) {
      focusAreaYearSelect.innerHTML = '<option value="all">All Years</option>';
      sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        focusAreaYearSelect.appendChild(option);
      });
    }
    
    // Populate Starts filter
    const startsYearSelect = document.getElementById('startsFilterYear');
    if (startsYearSelect) {
      startsYearSelect.innerHTML = '<option value="all">All Years</option>';
      sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        startsYearSelect.appendChild(option);
      });
    }
    
    renderReport();
  }

  function renderReport() {
    const currentEmail = (localStorage.getItem("loggedInUser") || "").toLowerCase();
    const profileKey = `profileData:${(localStorage.getItem("activeProfileEmail") || currentEmail).toLowerCase()}`;
    const profileData = JSON.parse(localStorage.getItem(profileKey) || "{}");
    const userRow = allAlumniRows.find(row => (row.Email || "").toLowerCase() === currentEmail);
    const alumniId = userRow ? userRow.AlumniID : null;
    const careerField = (userRow && (userRow.CareerField || userRow.Department)) || profileData.CareerField || profileData.Department || "";

    // Build alumni map
    const alumniMap = {};
    allAlumniRows.forEach(row => {
      if (row.AlumniID) alumniMap[row.AlumniID] = row;
    });

    // Load local mentorship requests
    const localMentorshipRequests = JSON.parse(localStorage.getItem(`localMentorshipRequests:${currentEmail}`) || "[]");
    const localMentorshipSessions = localMentorshipRequests.map(req => ({
      MenteeAlumniID: alumniId,
      FocusArea: req.FocusArea,
      StartDate: req.RequestDate,
      MentorshipStatus: req.MentorshipStatus || "Pending",
      Source: "Portal"
    }));
    
    // Combine all mentorship data and apply filters
    const allMentorshipData = allMentorshipRows.concat(localMentorshipSessions);
    const filteredMentorship = filterMentorship(allMentorshipData, alumniMap);
    
    const mySessions = filteredMentorship.filter(row => row.MenteeAlumniID === alumniId || row.MentorAlumniID === alumniId);
    const myActive = mySessions.filter(row => row.MentorshipStatus === "Active");
    const myCompleted = mySessions.filter(row => row.MentorshipStatus === "Completed");

    const totalSessions = mySessions.length;
    const csvSessions = allMentorshipRows.filter(row => row.MenteeAlumniID === alumniId || row.MentorAlumniID === alumniId).length;
    const localSessions = localMentorshipSessions.length;

    document.getElementById("myActiveSessions").innerText = myActive.length;
    document.getElementById("myActiveNote").innerText = myActive.length
      ? `Active sessions${totalSessions > csvSessions ? ` (${csvSessions} from records, ${localSessions} from portal)` : ""}.`
      : "No active mentorship sessions yet.";

    document.getElementById("myCompletedSessions").innerText = myCompleted.length;
    document.getElementById("myCompletedNote").innerText = myCompleted.length
      ? "Completed sessions show how many mentorships you have finished."
      : "Complete a mentorship cycle to populate this metric.";

    const campusActive = filteredMentorship.filter(row => row.MentorshipStatus === "Active").length;
    document.getElementById("campusActive").innerText = campusActive;
    document.getElementById("campusActiveNote").innerText = campusActive
      ? "Active mentorships across the wider community."
      : "The mentorship program is waiting for its first cohort.";

    // Apply focusAreaFilter to filteredMentorship
    let focusAreaFilteredMentorship = filteredMentorship.filter(row => {
      if (!row.StartDate) return false;
      const startDate = new Date(row.StartDate);
      if (isNaN(startDate.getTime())) return false;
      
      const rowYear = startDate.getFullYear();
      const rowMonth = startDate.getMonth() + 1;
      
      // Filter by year
      if (focusAreaFilter.year !== 'all' && rowYear !== parseInt(focusAreaFilter.year)) {
        return false;
      }
      
      // Filter by month
      if (focusAreaFilter.month !== 'all' && rowMonth !== parseInt(focusAreaFilter.month)) {
        return false;
      }
      
      return true;
    });
    
    // Store filtered data globally for modal access
    currentFilteredMentorships = focusAreaFilteredMentorship;

    const focusCounts = {};
    const focusMentorSupply = {};
    const focusMenteeDemand = {};
    const focusMentors = {}; // Store mentor details for drill-down
    const focusMentees = {}; // Store mentee details for drill-down
    
    // Include CSV data
    focusAreaFilteredMentorship.forEach(row => {
      const focus = row.FocusArea || "Career Growth";
      const mentorId = row.MentorAlumniID;
      const menteeId = row.MenteeAlumniID;
      focusCounts[focus] = (focusCounts[focus] || 0) + 1;
      if (!focusMentorSupply[focus]) {
        focusMentorSupply[focus] = new Set();
        focusMentors[focus] = [];
      }
      if (!focusMenteeDemand[focus]) {
        focusMenteeDemand[focus] = new Set();
        focusMentees[focus] = [];
      }
      if (mentorId && !focusMentorSupply[focus].has(mentorId)) {
      focusMentorSupply[focus].add(mentorId);
        const mentor = alumniMap[mentorId];
        if (mentor) {
          focusMentors[focus].push(`${mentor.FirstName || ''} ${mentor.LastName || ''}`.trim() || mentorId);
        }
      }
      if (menteeId && !focusMenteeDemand[focus].has(menteeId)) {
      focusMenteeDemand[focus].add(menteeId);
        const mentee = alumniMap[menteeId];
        if (mentee) {
          focusMentees[focus].push(`${mentee.FirstName || ''} ${mentee.LastName || ''}`.trim() || menteeId);
        }
      }
    });
    // Calculate starts by month with filter
    let startsFilteredMentorship = filteredMentorship.filter(row => {
      if (!row.StartDate) return false;
      const startDate = new Date(row.StartDate);
      if (isNaN(startDate.getTime())) return false;
      
      const rowYear = startDate.getFullYear();
      const rowMonth = startDate.getMonth() + 1;
      
      // Filter by year
      if (startsFilter.year !== 'all' && rowYear !== parseInt(startsFilter.year)) {
        return false;
      }
      
      // Filter by month
      if (startsFilter.month !== 'all' && rowMonth !== parseInt(startsFilter.month)) {
        return false;
      }
      
      return true;
    });
    
    const startsByMonth = {};
    startsFilteredMentorship.forEach(row => {
      const dt = parseDate(row.StartDate);
      if (!dt) return;
      const key = monthKey(dt);
      startsByMonth[key] = (startsByMonth[key] || 0) + 1;
    });
    
    // Destroy existing charts
    Object.values(chartInstances).forEach(chart => {
      if (chart) chart.destroy();
    });
    chartInstances = {};
    
    // Focus area insights
    const focusLabels = Object.keys(focusCounts);
    const focusMentorSeries = focusLabels.map(label => focusMentorSupply[label] ? focusMentorSupply[label].size : 0);
    const focusMenteeSeries = focusLabels.map(label => focusMenteeDemand[label] ? focusMenteeDemand[label].size : 0);
    
    const focusInsights = focusLabels.map(label => ({
      label,
      sessions: focusCounts[label],
      gap: (focusMenteeDemand[label] ? focusMenteeDemand[label].size : 0) - (focusMentorSupply[label] ? focusMentorSupply[label].size : 0)
    })).sort((a, b) => b.sessions - a.sessions);
    const topFocus = focusInsights[0] || null;
    document.getElementById("topFocus").innerText = topFocus ? topFocus.label : "TBD";
    document.getElementById("topFocusNote").innerText = topFocus
      ? `${topFocus.sessions} pairings are focused on ${topFocus.label}.`
      : "Focus areas will appear as soon as mentorship requests arrive.";

    const userFocusIndex = careerField
      ? focusLabels.findIndex(label => label.toLowerCase() === careerField.toLowerCase())
      : -1;
    const mentorColors = focusLabels.map((_, idx) => idx === userFocusIndex ? "rgba(11,61,145,0.9)" : "rgba(11,61,145,0.6)");
    const menteeColors = focusLabels.map((_, idx) => idx === userFocusIndex ? "rgba(16,185,129,0.9)" : "rgba(16,185,129,0.6)");

    chartInstances.focusArea = new Chart(document.getElementById("focusAreaChart"), {
      type: "bar",
      data: {
        labels: focusLabels,
        datasets: [{
          label: "Mentor Supply",
          data: focusMentorSeries,
          backgroundColor: mentorColors
        },
        {
          label: "Mentee Demand",
          data: focusMenteeSeries,
          backgroundColor: menteeColors
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const index = elements[0].index;
            const focus = focusLabels[index];
            const mentors = focusMentors[focus] || [];
            const mentees = focusMentees[focus] || [];
            const mentorCount = focusMentorSeries[index] || 0;
            const menteeCount = focusMenteeSeries[index] || 0;
            
            showDrilldown(focus, mentorCount, menteeCount, mentors, mentees);
          }
        }
      }
    });

    const focusChartNote = document.getElementById("focusChartNote");
    const focusChartHighlight = document.getElementById("focusChartHighlight");
    const focusChartCTA = document.getElementById("focusChartCTA");
    const focusInviteCTA = document.getElementById("focusInviteCTA");
    
    // Calculate biggestGap for use throughout
    const biggestGap = focusInsights.length > 0
      ? focusInsights
        .slice()
        .sort((a, b) => b.gap - a.gap)[0]
      : null;
    
    // Update focus area subtitle to show filter
    if (focusChartHighlight) {
      const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      let filterText = 'Top focus areas';
      
      if (focusAreaFilter.year !== 'all' || focusAreaFilter.month !== 'all') {
        filterText = 'Showing mentorships starting in ';
        if (focusAreaFilter.month !== 'all' && focusAreaFilter.year !== 'all') {
          filterText += `${monthNames[parseInt(focusAreaFilter.month)]} ${focusAreaFilter.year}`;
        } else if (focusAreaFilter.month !== 'all') {
          filterText += `${monthNames[parseInt(focusAreaFilter.month)]} (all years)`;
        } else if (focusAreaFilter.year !== 'all') {
          filterText += focusAreaFilter.year;
        }
      } else if (focusLabels.length) {
        const highlightLabel = userFocusIndex >= 0 ? focusLabels[userFocusIndex] : (biggestGap ? biggestGap.label : null);
        if (highlightLabel) {
          filterText = userFocusIndex >= 0 ? `Your focus: ${highlightLabel}` : `Greatest unmet demand: ${highlightLabel}`;
        }
      }
      
      focusChartHighlight.innerText = filterText;
    }
    
    if (focusLabels.length) {
      if (focusChartNote) {
        if (biggestGap && biggestGap.gap > 0) {
          focusChartNote.innerText = `${biggestGap.label} needs ${biggestGap.gap} more mentor${biggestGap.gap === 1 ? "" : "s"} than we currently have‚Äîinvite alumni in this area.`;
        } else if (topFocus) {
          focusChartNote.innerText = `${topFocus.label} leads with ${topFocus.sessions} sessions. Consider sharing best practices from this focus.`;
        }
      }
    } else {
      if (focusChartHighlight) focusChartHighlight.innerText = "Focus mix";
      if (focusChartNote) focusChartNote.innerText = "Once mentorship requests arrive, this chart will highlight where to volunteer.";
      if (focusChartCTA) focusChartCTA.style.display = "none";
      if (focusInviteCTA) focusInviteCTA.style.display = "none";
    }
    
    if (focusChartCTA) {
      focusChartCTA.onclick = () => { window.location.href = "mentorship.html"; };
      if (userFocusIndex >= 0) {
        focusChartCTA.querySelector("span").innerText = `Mentor in ${focusLabels[userFocusIndex]}`;
      }
    }
    if (focusInviteCTA) {
      focusInviteCTA.onclick = () => {
        const inviteText = "Join me as a mentor! Our alumni mentees need more support here: " + window.location.origin + "/mentorship.html";
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(inviteText).then(() => {
            alert("Invite copied‚Äîpaste it into your alumni group chat or email.");
          }).catch(() => {
            alert(inviteText);
          });
        } else {
          alert(inviteText);
        }
      };
    }

    // No filtering - use all data
    const startKeys = Object.keys(startsByMonth).sort();
    const startValues = startKeys.map(key => startsByMonth[key]);
    const rollingAverage = calculateMovingAverage(startValues, 3);
    
    chartInstances.startMonth = new Chart(document.getElementById("startMonthChart"), {
      type: "line",
      data: {
        labels: startKeys.map(key => {
          const [year, month] = key.split("-");
          return new Date(parseInt(year, 10), parseInt(month, 10) - 1).toLocaleDateString("en-US", { month: "short", year: "numeric" });
        }),
        datasets: [{
          label: "Starts",
          data: startValues,
          borderColor: "#0b3d91",
          backgroundColor: "rgba(11,61,145,0.2)",
          fill: true,
          tension: 0.3,
          pointRadius: 4
        },
        {
          label: "3-Month Moving Average",
          data: rollingAverage,
          borderColor: "#f59e0b",
          borderDash: [6, 6],
          fill: false,
          tension: 0.2,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
        onClick: () => {
          // Pass all data to modal
          showStartsAnalysisModal(startsByMonth, startKeys, startValues);
        }
      }
    });
    const startMonthNote = document.getElementById("startMonthNote");
    const startsCTA = document.getElementById("startsCTA");
    if (startMonthNote && startKeys.length) {
      const latestKey = startKeys[startKeys.length - 1];
      const latestDate = new Date(parseInt(latestKey.split("-")[0], 10), parseInt(latestKey.split("-")[1], 10) - 1);
      const latestStarts = startsByMonth[latestKey];
      const trailingAvg = rollingAverage[rollingAverage.length - 1];
      const peak = startKeys
        .map(key => ({ key, value: startsByMonth[key] }))
        .sort((a, b) => b.value - a.value)[0];
      if (latestStarts < trailingAvg) {
        startMonthNote.innerText = `${latestDate.toLocaleDateString("en-US", { month: "long", year: "numeric" })} is trending below average‚Äîline up mentor recruitment now.`;
      } else {
        startMonthNote.innerText = `On pace: ${latestDate.toLocaleDateString("en-US", { month: "long", year: "numeric" })} is beating the 3-month average. Peak month to emulate: ${new Date(parseInt(peak.key.split("-")[0],10), parseInt(peak.key.split("-")[1],10)-1).toLocaleDateString("en-US",{ month:"long", year:"numeric"})}.`;
      }
    }
    if (startsCTA) {
      startsCTA.onclick = () => {
        alert("Share the mentorship signup link with your fellow alumni or social channels‚Äîmomentum grows when mentors personally invite one another.");
      };
    } else {
      if (startMonthNote) startMonthNote.innerText = "We‚Äôll chart momentum once mentorships begin. Kick off the first cohort today.";
      if (startsCTA) startsCTA.style.display = "none";
    }

    // Apply gradYearFilter to filteredMentorship
    let gradYearFilteredMentorship = filteredMentorship.filter(row => {
      if (!row.StartDate) return false;
      const startDate = new Date(row.StartDate);
      if (isNaN(startDate.getTime())) return false;
      
      const rowMonth = startDate.getMonth() + 1;
      
      // Filter by month
      if (gradYearFilter.month !== 'all' && rowMonth !== parseInt(gradYearFilter.month)) {
        return false;
      }
      
      return true;
    });
    
    const gradYearCounts = {};
    gradYearFilteredMentorship.forEach(row => {
      const mentee = alumniMap[row.MenteeAlumniID];
      if (!mentee || !mentee.GraduationYear) return;
      gradYearCounts[mentee.GraduationYear] = (gradYearCounts[mentee.GraduationYear] || 0) + 1;
    });
    const gradKeys = Object.keys(gradYearCounts).sort();
    const gradValues = gradKeys.map(key => gradYearCounts[key]);
    const userGradYear = userRow && userRow.GraduationYear ? String(userRow.GraduationYear) : null;
    const gradColors = gradKeys.map(year => year === userGradYear ? "rgba(11,61,145,0.85)" : "rgba(16,185,129,0.7)");
    
    // Store grad year data globally for modal access
    gradYearAnalysisData = { gradKeys, gradValues, gradYearCounts };
    
    // Update subtitle to show active filters
    const gradYearSubtitle = document.getElementById('gradYearSubtitle');
    if (gradYearSubtitle) {
      const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      let filterText = 'Who mentees are today';
      
      if (gradYearFilter.month !== 'all') {
        filterText = `Showing mentorships starting in ${monthNames[parseInt(gradYearFilter.month)]}`;
      }
      
      gradYearSubtitle.innerText = filterText;
    }
    
    chartInstances.gradYear = new Chart(document.getElementById("gradYearChart"), {
      type: "bar",
      data: {
        labels: gradKeys,
        datasets: [{
          data: gradKeys.map(key => gradYearCounts[key]),
          backgroundColor: gradColors
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
        plugins: {
          legend: {
            display: false
          }
        },
        onClick: function(event, elements) {
          showGradYearAnalysisModal();
        }
      }
    });
    const gradYearNote = document.getElementById("gradYearNote");
    const gradYearCTA = document.getElementById("gradYearCTA");
    if (gradYearNote && gradKeys.length) {
      const topYear = gradKeys
        .map(year => ({ year, count: gradYearCounts[year] }))
        .sort((a, b) => b.count - a.count)[0];
      if (userGradYear && gradYearCounts[userGradYear]) {
        gradYearNote.innerText = `Your class (${userGradYear}) represents ${gradYearCounts[userGradYear]} mentee${gradYearCounts[userGradYear] === 1 ? "" : "s"} ‚Äî share your experience with them.`;
      } else {
        gradYearNote.innerText = `Most mentees hail from the class of ${topYear.year}. Invite alumni from nearby cohorts to mentor.`;
      }
    } else {
      if (gradYearNote) gradYearNote.innerText = "Encourage mentees to share their graduation year so we can better match mentors.";
      if (gradYearCTA) gradYearCTA.style.display = "none";
    }
    if (gradYearCTA) {
      gradYearCTA.onclick = () => { window.location.href = "mentorship.html"; };
      if (userGradYear) {
        gradYearCTA.querySelector("span").innerText = `Support class of ${userGradYear}`;
      }
    }

    const recList = document.getElementById("mentorshipRecommendations");
    recList.innerHTML = "";
    
    // Recommendation 1: Explore high-demand focus areas
    if (focusInsights.length) {
      const topFocusAreas = focusInsights.slice(0, 3).map(f => f.label);
      if (topFocusAreas.length > 0) {
        recList.innerHTML += `<li><strong>Explore High-Demand Areas:</strong> The most popular mentorship focus areas are ${topFocusAreas.join(', ')}. Consider requesting mentorship in these areas to connect with experienced alumni.</li>`;
      }
    }
    
    // Recommendation 2: Find mentors in your field
    if (careerField) {
      const alignedMentors = allMentorshipRows.filter(row => (row.FocusArea || "").toLowerCase() === careerField.toLowerCase());
      if (alignedMentors.length) {
        recList.innerHTML += `<li><strong>Connect with Your Field:</strong> ${alignedMentors.length} active mentorship${alignedMentors.length === 1 ? '' : 's'} available in ${careerField}. Click on the focus area chart above to see mentor profiles and request a match.</li>`;
      } else {
        recList.innerHTML += `<li><strong>Pioneer Your Field:</strong> Be among the first to establish ${careerField} mentorship connections. Request a mentor or volunteer to mentor others in this emerging area.</li>`;
      }
    } else {
      recList.innerHTML += `<li><strong>Complete Your Profile:</strong> Add your career field and interests to your profile to receive personalized mentorship recommendations tailored to your goals.</li>`;
    }

    // Recommendation 3: Based on user's mentorship status
    if (myActive.length === 0) {
      recList.innerHTML += `<li><strong>Start Your Mentorship Journey:</strong> Request your first mentorship session to gain valuable career guidance, expand your network, and accelerate your professional growth.</li>`;
    } else {
      recList.innerHTML += `<li><strong>Maximize Your Sessions:</strong> You have ${myActive.length} active mentorship${myActive.length === 1 ? '' : 's'}. Set clear goals for each meeting and prepare questions in advance to get the most value from your time together.</li>`;
    }
    
    // Recommendation 4: Become a mentor (pay it forward)
    const totalMentees = allMentorshipRows.filter(row => row.MenteeAlumniID).length;
    if (totalMentees > 0) {
      recList.innerHTML += `<li><strong>Give Back to the Community:</strong> ${totalMentees} alumni are currently seeking mentorship. Share your experience by volunteering as a mentor and help the next generation of alumni succeed.</li>`;
    }
    
    // Recommendation 5: Find mentors from your graduation cohort
    if (userRow && userRow.GraduationYear && Object.keys(gradYearCounts).length > 0) {
      const userGradYear = parseInt(userRow.GraduationYear);
      const nearbyYears = Object.keys(gradYearCounts)
        .map(Number)
        .filter(year => Math.abs(year - userGradYear) <= 3);
      
      if (nearbyYears.length > 0) {
        recList.innerHTML += `<li><strong>Connect with Your Cohort:</strong> Alumni from ${nearbyYears[0]}‚Äì${nearbyYears[nearbyYears.length - 1]} are actively engaged in mentorship. Connecting with peers from your era can create strong, relatable mentorship relationships.</li>`;
      }
    }
    
    // Fallback if no recommendations generated
    if (!recList.innerHTML) {
      recList.innerHTML = "<li><strong>Get Started:</strong> Explore the charts above to discover mentorship opportunities, view mentor profiles, and submit your first mentorship request to begin building valuable professional connections.</li>";
    }
  }

  // Mentorship Starts Analysis Modal Functions
  function showStartsAnalysisModal(startsByMonth, startKeys, startValues) {
    const modal = document.getElementById('startsAnalysisModal');
    modal.style.display = 'flex';
    
    // Check if we have data
    if (!startKeys || startKeys.length === 0 || !startValues || startValues.length === 0) {
      document.getElementById('startsAnalysisText').innerHTML = '<em>No mentorship data available for analysis.</em>';
      return;
    }
    
    // Destroy existing charts if they exist
    Object.values(startsAnalysisCharts).forEach(chart => {
      if (chart) chart.destroy();
    });
    startsAnalysisCharts = {};
    
    // Prepare data for charts
    const monthLabels = startKeys.map(key => {
      const [year, month] = key.split("-");
      return new Date(parseInt(year, 10), parseInt(month, 10) - 1).toLocaleDateString("en-US", { month: "short", year: "2-digit" });
    });
    
    // Find highest and lowest months
    const maxValue = Math.max(...startValues);
    const minValue = Math.min(...startValues);
    
    // Color code based on high/low
    const barColors = startValues.map(val => {
      if (val === maxValue) return '#10b981'; // Green for highest
      if (val === minValue) return '#ef4444'; // Red for lowest
      return '#3b82f6'; // Blue for others
    });
    
    // 1. Bar Chart: Monthly Highs & Lows
    startsAnalysisCharts.highsLows = new Chart(document.getElementById('monthlyHighsLowsChart'), {
      type: 'bar',
      data: {
        labels: monthLabels,
        datasets: [{
          label: 'Mentorship Starts',
          data: startValues,
          backgroundColor: barColors,
          borderColor: barColors.map(c => c),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
    
    // 2. Donut Chart: Seasonal Patterns
    const seasonData = { Spring: 0, Summer: 0, Fall: 0, Winter: 0 };
    startKeys.forEach((key, idx) => {
      const [year, month] = key.split("-");
      const monthNum = parseInt(month, 10);
      const season = getSeason(monthNum);
      seasonData[season] += startValues[idx];
    });
    
    startsAnalysisCharts.seasonal = new Chart(document.getElementById('seasonalPatternsChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(seasonData),
        datasets: [{
          data: Object.values(seasonData),
          backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6'],
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { padding: 10, font: { size: 11 } }
          }
        }
      }
    });
    
    // 3. Line Chart: Recruitment Drop-Off
    // Focus on the trend, especially the drop in late 2025-2026
    startsAnalysisCharts.dropOff = new Chart(document.getElementById('dropOffChart'), {
      type: 'line',
      data: {
        labels: monthLabels,
        datasets: [{
          label: 'Mentorship Starts',
          data: startValues,
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3,
          pointBackgroundColor: '#ef4444'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
    
    // Generate Analysis Text
    const maxIndex = startValues.indexOf(maxValue);
    const minIndex = startValues.indexOf(minValue);
    const strongestMonth = monthLabels[maxIndex];
    const weakestMonth = monthLabels[minIndex];
    
    // Find which season is strongest
    const strongestSeason = Object.keys(seasonData).reduce((a, b) => seasonData[a] > seasonData[b] ? a : b);
    const weakestSeason = Object.keys(seasonData).reduce((a, b) => seasonData[a] < seasonData[b] ? a : b);
    
    // Detect drop-off (look for declining trend in later months)
    const recentValues = startValues.slice(-6); // Last 6 months
    const earlyValues = startValues.slice(0, 6); // First 6 months
    const avgRecent = recentValues.reduce((a, b) => a + b, 0) / recentValues.length;
    const avgEarly = earlyValues.reduce((a, b) => a + b, 0) / earlyValues.length;
    const isDropping = avgRecent < avgEarly;
    
    const analysisText = `
      The monthly highs and lows chart reveals clear peaks and valleys in mentorship recruitment activity. 
      Peak months show strong alumni engagement with ${maxValue} new mentorship starts, while quieter periods 
      see recruitment drop to ${minValue} starts. This variation highlights that certain times of year are more 
      conducive to starting new mentorship relationships than others.
      <br><br>
      Looking at seasonal patterns, <strong>${strongestSeason}</strong> emerges as the most active season for mentorship starts, 
      indicating this is when alumni are most motivated to engage in mentorship relationships. In contrast, <strong>${weakestSeason}</strong> 
      shows the weakest recruitment, suggesting this may be a challenging time to attract new mentorship pairs. Understanding these 
      seasonal rhythms helps alumni choose the best times to participate or promote the program.
      <br><br>
      ${isDropping ? 
        `The recruitment drop-off chart reveals a concerning trend: mentorship starts are declining in recent months. 
        The numbers begin to fall and remain low, signaling that recruitment momentum has slowed significantly. 
        This is why the "Promote next cohort" call-to-action is critical‚Äîwithout active promotion and outreach, 
        the mentorship program risks losing participation. Alumni engagement is needed now to reverse this trend and 
        bring new energy to the program.` : 
        `The recruitment trend shows consistent activity over time, though ongoing promotion is still essential to 
        maintain momentum and attract new mentorship pairs. Regular outreach helps ensure the program continues to thrive.`
      }
    `;
    
    document.getElementById('startsAnalysisText').innerHTML = analysisText;
  }
  
  function closeStartsAnalysisModal() {
    const modal = document.getElementById('startsAnalysisModal');
    modal.style.display = 'none';
    
    // Destroy charts
    Object.values(startsAnalysisCharts).forEach(chart => {
      if (chart) chart.destroy();
    });
    startsAnalysisCharts = {};
  }
  
  
  function getSeason(month) {
    if (month >= 3 && month <= 5) return 'Spring';
    if (month >= 6 && month <= 8) return 'Summer';
    if (month >= 9 && month <= 11) return 'Fall';
    return 'Winter';
  }
  
  // Grad Year Analysis Modal Functions
  function showGradYearAnalysisModal() {
    const modal = document.getElementById('gradYearAnalysisModal');
    
    // Check if we have data
    if (!gradYearAnalysisData.gradKeys || gradYearAnalysisData.gradKeys.length === 0) {
      document.getElementById('gradYearInsightsText').innerHTML = '<em>No graduation year data available for analysis.</em>';
      modal.style.display = 'flex';
      return;
    }
    
    // Destroy existing charts if they exist
    Object.values(gradYearAnalysisCharts).forEach(chart => {
      if (chart) chart.destroy();
    });
    gradYearAnalysisCharts = {};
    
    const { gradKeys, gradValues, gradYearCounts } = gradYearAnalysisData;
    
    // Show modal first
    modal.style.display = 'flex';
    
    // Use setTimeout to ensure DOM is updated before creating chart
    setTimeout(() => {
      // Line Chart - Cohort Trend
      gradYearAnalysisCharts.line = new Chart(document.getElementById('gradYearLineChart'), {
      type: 'line',
      data: {
        labels: gradKeys,
        datasets: [{
          label: 'Mentees',
          data: gradValues,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: '#10b981'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        },
        onClick: function(event, elements) {
          if (elements.length > 0) {
            const index = elements[0].index;
            const selectedYear = gradKeys[index];
            showGradYearMenteeDetails(selectedYear);
          }
        }
      }
    });
    
    // Generate Dynamic Insights
    const maxValue = Math.max(...gradValues);
    const minValue = Math.min(...gradValues);
    const maxYearIndex = gradValues.indexOf(maxValue);
    const minYearIndex = gradValues.indexOf(minValue);
    const maxYear = gradKeys[maxYearIndex];
    const minYear = gradKeys[minYearIndex];
    
    // Determine distribution pattern
    let pattern = '';
    let patternDescription = '';
    
    if (gradKeys.length >= 3) {
      // Check if clustered (one year significantly higher than others)
      const avgValue = gradValues.reduce((a, b) => a + b, 0) / gradValues.length;
      const valuesAboveDouble = gradValues.filter(v => v > avgValue * 1.5).length;
      
      if (valuesAboveDouble === 1 && maxValue > minValue * 2) {
        pattern = 'clustered';
        patternDescription = `The distribution is heavily clustered around the class of ${maxYear}, with ${maxValue} mentees compared to ${minValue} in ${minYear}. This concentration suggests a specific cohort is driving mentee demand.`;
      } else {
        // Check trend: increasing, decreasing, or even
        const firstHalf = gradValues.slice(0, Math.floor(gradValues.length / 2));
        const secondHalf = gradValues.slice(Math.floor(gradValues.length / 2));
        const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
        const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
        
        if (secondAvg > firstAvg * 1.2) {
          pattern = 'increasing';
          patternDescription = `Mentee demand shows an increasing trend across graduation years, with more recent cohorts seeking mentorship. This indicates growing interest in mentorship programs among newer alumni.`;
        } else if (firstAvg > secondAvg * 1.2) {
          pattern = 'declining';
          patternDescription = `Mentee demand shows a declining trend, with earlier graduation years having higher participation. This suggests that older alumni cohorts are more engaged in seeking mentorship.`;
        } else {
          pattern = 'even';
          patternDescription = `Mentee distribution is relatively even across graduation years, with counts ranging from ${minValue} to ${maxValue}. This balanced distribution indicates consistent interest across different alumni cohorts.`;
        }
      }
    } else {
      patternDescription = `Mentee distribution spans ${gradKeys.length} graduation year${gradKeys.length === 1 ? '' : 's'}, with counts ranging from ${minValue} to ${maxValue}.`;
    }
    
    // Mentorship implications
    const implications = `The class of <strong>${maxYear}</strong> currently has the highest mentee volume with ${maxValue} mentees, indicating higher mentor demand for that cohort. In contrast, the class of <strong>${minYear}</strong> has ${minValue} mentee${minValue === 1 ? '' : 's'}, representing the lowest current demand. These patterns help identify which cohorts need the most mentor support and where recruitment efforts should focus.`;
    
    const insightsText = `
      ${patternDescription}
      <br><br>
      ${implications}
    `;
    
    document.getElementById('gradYearInsightsText').innerHTML = insightsText;
    }, 50); // Small delay to ensure DOM is ready
  }
  
  function closeGradYearAnalysisModal() {
    const modal = document.getElementById('gradYearAnalysisModal');
    modal.style.display = 'none';
    
    // Destroy charts
    Object.values(gradYearAnalysisCharts).forEach(chart => {
      if (chart) chart.destroy();
    });
    gradYearAnalysisCharts = {};
  }
  
  function showGradYearMenteeDetails(graduationYear) {
    // Build alumni map
    const alumniMap = {};
    allAlumniRows.forEach(row => {
      if (row.AlumniID) alumniMap[row.AlumniID] = row;
    });
    
    // Get current filter
    let relevantMentorships = allMentorshipRows.filter(row => {
      if (!row.StartDate) return false;
      const startDate = new Date(row.StartDate);
      if (isNaN(startDate.getTime())) return false;
      
      const rowMonth = startDate.getMonth() + 1;
      
      // Apply month filter if set
      if (gradYearFilter.month !== 'all' && rowMonth !== parseInt(gradYearFilter.month)) {
        return false;
      }
      
      return true;
    });
    
    // Find all mentees with the selected graduation year
    const menteesInYear = [];
    const seenMentees = new Set();
    
    relevantMentorships.forEach(row => {
      const mentee = alumniMap[row.MenteeAlumniID];
      if (mentee && mentee.GraduationYear == graduationYear && !seenMentees.has(row.MenteeAlumniID)) {
        seenMentees.add(row.MenteeAlumniID);
        
        // Find mentor for this mentorship
        const mentor = alumniMap[row.MentorAlumniID];
        
        menteesInYear.push({
          id: row.MenteeAlumniID,
          name: `${mentee.FirstName || ''} ${mentee.LastName || ''}`.trim() || 'Unknown',
          department: mentee.Department || 'N/A',
          position: mentee.Occupation || mentee.CurrentPosition || 'N/A',
          focusArea: row.FocusArea || 'N/A',
          status: row.Status || 'N/A',
          mentorName: mentor ? `${mentor.FirstName || ''} ${mentor.LastName || ''}`.trim() : 'Unmatched',
          startDate: row.StartDate || 'N/A'
        });
      }
    });
    
    // Sort by name
    menteesInYear.sort((a, b) => a.name.localeCompare(b.name));
    
    // Build modal content
    let modalContent = `
      <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 8px 0; color: #1d3557; font-size: 16px;">Class of ${graduationYear} Mentees</h4>
        <p style="margin: 0; color: #64748b; font-size: 14px;">${menteesInYear.length} mentee${menteesInYear.length === 1 ? '' : 's'} currently seeking or receiving mentorship</p>
      </div>
    `;
    
    if (menteesInYear.length === 0) {
      modalContent += `<p style="text-align: center; color: #64748b; padding: 40px 20px;">No mentees found for this graduation year with the current filter.</p>`;
    } else {
      menteesInYear.forEach(mentee => {
        modalContent += `
          <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                <h5 style="margin: 0 0 4px 0; color: #1e293b; font-size: 15px; font-weight: 600;">${mentee.name}</h5>
                <p style="margin: 0; color: #64748b; font-size: 13px;">${mentee.position}</p>
              </div>
              <button onclick="requestConnection('${mentee.id}', '${mentee.name.replace(/'/g, "\\'")}')" 
                      style="background: #0ea5e9; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-user-plus" style="margin-right: 4px;"></i> Connect
              </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 12px; font-size: 13px;">
              <div>
                <strong style="color: #475569;">Department:</strong>
                <span style="color: #64748b;">${mentee.department}</span>
              </div>
              <div>
                <strong style="color: #475569;">Focus Area:</strong>
                <span style="color: #64748b;">${mentee.focusArea}</span>
              </div>
              ${mentee.status !== 'N/A' ? `
              <div>
                <strong style="color: #475569;">Status:</strong>
                <span style="color: ${mentee.status === 'Active' ? '#10b981' : '#64748b'}; font-weight: 600;">${mentee.status}</span>
              </div>
              ` : ''}
              <div>
                <strong style="color: #475569;">Mentor:</strong>
                <span style="color: ${mentee.mentorName === 'Unmatched' ? '#f59e0b' : '#64748b'};">${mentee.mentorName}</span>
              </div>
            </div>
            
            ${mentee.startDate !== 'N/A' ? `
              <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #64748b;">
                <i class="fas fa-calendar" style="margin-right: 4px;"></i> Started: ${new Date(mentee.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </div>
            ` : ''}
          </div>
        `;
      });
    }
    
    // Display in a simple modal (hide focus-area specific elements)
    const modal = document.getElementById('drilldownModal');
    const titleEl = document.getElementById('drilldownTitle');
    const listEl = document.getElementById('drilldownList');
    const gapSummaryEl = document.getElementById('gapSummary');
    const focusDescEl = document.getElementById('focusDescription');
    const miniChartContainer = document.getElementById('miniChartContainer');
    
    if (modal && titleEl && listEl) {
      titleEl.innerText = `Class of ${graduationYear} - Mentee Details`;
      listEl.innerHTML = modalContent;
      
      // Hide focus-area specific elements
      if (gapSummaryEl) gapSummaryEl.style.display = 'none';
      if (focusDescEl) focusDescEl.style.display = 'none';
      if (miniChartContainer) miniChartContainer.style.display = 'none';
      
      // Hide action buttons
      const actionButtons = modal.querySelector('.chart-actions');
      if (actionButtons) actionButtons.style.display = 'none';
      
      // Set higher z-index to appear on top of grad year analysis modal
      modal.style.zIndex = '2000';
      modal.style.display = 'flex';
    }
  }
  
  function applyGradYearFilter() {
    const monthSelect = document.getElementById('gradYearFilterMonth');
    
    gradYearFilter.month = monthSelect.value;
    
    // Destroy existing chart before re-rendering
    if (chartInstances.gradYear) {
      chartInstances.gradYear.destroy();
    }
    
    renderReport();
  }
  
  function resetGradYearFilter() {
    gradYearFilter.month = 'all';
    
    document.getElementById('gradYearFilterMonth').value = 'all';
    
    // Destroy existing chart before re-rendering
    if (chartInstances.gradYear) {
      chartInstances.gradYear.destroy();
    }
    
    renderReport();
  }
  
  function applyFocusAreaFilter() {
    const yearSelect = document.getElementById('focusAreaFilterYear');
    const monthSelect = document.getElementById('focusAreaFilterMonth');
    
    focusAreaFilter.year = yearSelect.value;
    focusAreaFilter.month = monthSelect.value;
    
    // Destroy existing chart before re-rendering
    if (chartInstances.focusArea) {
      chartInstances.focusArea.destroy();
    }
    
    renderReport();
  }
  
  function resetFocusAreaFilter() {
    focusAreaFilter.year = 'all';
    focusAreaFilter.month = 'all';
    
    document.getElementById('focusAreaFilterYear').value = 'all';
    document.getElementById('focusAreaFilterMonth').value = 'all';
    
    // Destroy existing chart before re-rendering
    if (chartInstances.focusArea) {
      chartInstances.focusArea.destroy();
    }
    
    renderReport();
  }
  
  function applyStartsFilter() {
    const yearSelect = document.getElementById('startsFilterYear');
    const monthSelect = document.getElementById('startsFilterMonth');
    
    startsFilter.year = yearSelect.value;
    startsFilter.month = monthSelect.value;
    
    // Destroy existing chart before re-rendering
    if (chartInstances.startMonth) {
      chartInstances.startMonth.destroy();
    }
    
    renderReport();
  }
  
  function resetStartsFilter() {
    startsFilter.year = 'all';
    startsFilter.month = 'all';
    
    document.getElementById('startsFilterYear').value = 'all';
    document.getElementById('startsFilterMonth').value = 'all';
    
    // Destroy existing chart before re-rendering
    if (chartInstances.startMonth) {
      chartInstances.startMonth.destroy();
    }
    
    renderReport();
  }
  
  // Close modal when clicking outside
  window.onclick = function(event) {
    const startsModal = document.getElementById('startsAnalysisModal');
    const gradYearModal = document.getElementById('gradYearAnalysisModal');
    if (event.target === startsModal) {
      closeStartsAnalysisModal();
    }
    if (event.target === gradYearModal) {
      closeGradYearAnalysisModal();
    }
  };

  if (!localStorage.getItem("isLoggedIn")) {
    window.location.href = "index.html";
  } else {
    initMentorshipReport();
  }
</script>

</body>
</html>

