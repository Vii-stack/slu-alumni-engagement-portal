<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alumni Portal Login</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="login-container">
  <h2>Welcome Back</h2>
  <p>Log in to access your account</p>

  <input type="email" id="emailInput" placeholder="Enter your email">
  <input type="password" id="passwordInput" placeholder="Enter your password">

  <button onclick="loginUser()">Continue</button>

  <p class="signup-text">
    Don't have an account? <a href="signup.html">Sign Up</a>
  </p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
async function loginUser() {
  const email = document.getElementById("emailInput").value.trim();
  const password = document.getElementById("passwordInput").value.trim();

  if (!email || !password) {
    alert("Please enter both email and password.");
    return;
  }

  try {
    const emailKey = email.toLowerCase();
    const newUserKey = `newUserData:${emailKey}`;
    const profileKey = `profileData:${emailKey}`;
    localStorage.setItem("activeProfileEmail", emailKey);

    // Load Alumni CSV to check if user exists
    localStorage.removeItem("profileData");
    localStorage.removeItem("newUserData");

    const alumniData = await loadCSV("data/Alumni.csv");
    const user = alumniData.find(a => a.Email && a.Email.toLowerCase() === emailKey);
    
    if (user) {
      // User exists in CSV - proceed to dashboard
      localStorage.setItem("loggedInUser", email);
      localStorage.setItem("isLoggedIn", "true");
      localStorage.setItem("profileFullName", `${user.FirstName || ''} ${user.LastName || ''}`.trim() || email);
      localStorage.setItem("profileEmail", email);
      localStorage.removeItem("isNewUser");
      localStorage.removeItem(newUserKey);
      
      window.location.href = "dashboard.html";
    } else {
      // New user - check localStorage for new user data
      const newUserData = localStorage.getItem(newUserKey);
      if (newUserData) {
        const userData = JSON.parse(newUserData);
        if (userData.Email && userData.Email.toLowerCase() === emailKey) {
          // New user from signup - redirect to profile to complete info
          localStorage.setItem("loggedInUser", email);
          localStorage.setItem("isLoggedIn", "true");
          localStorage.setItem("isNewUser", "true");
          localStorage.setItem("profileFullName", `${userData.FirstName || ''} ${userData.LastName || ''}`.trim() || email);
          localStorage.setItem("profileEmail", email);
          localStorage.setItem(profileKey, JSON.stringify(userData));
          window.location.href = "dashboard.html";
        } else {
          alert("User not found. Please sign up first.");
          window.location.href = "signup.html";
        }
      } else {
        alert("User not found. Please sign up first.");
        window.location.href = "signup.html";
      }
    }
  } catch (error) {
    console.error("Error loading Alumni data:", error);
    // Fallback: allow login with localStorage
    localStorage.setItem("loggedInUser", email);
    localStorage.setItem("isLoggedIn", "true");
    localStorage.setItem("activeProfileEmail", email.toLowerCase());
    window.location.href = "dashboard.html";
  }
}

function loadCSV(file) {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      download: true,
      header: true,
      complete: (results) => resolve(results.data.filter(row => row.AlumniID || row.Email)),
      error: (error) => reject(error)
    });
  });
}

// Allow Enter key to submit
document.getElementById("passwordInput")?.addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    loginUser();
  }
});

// Pre-fill email if coming from signup
const pendingEmail = localStorage.getItem("pendingSignupEmail");
if (pendingEmail) {
  const emailInput = document.getElementById("emailInput");
  if (emailInput) emailInput.value = pendingEmail;
  localStorage.removeItem("pendingSignupEmail");
}
</script>

</body>
</html>
